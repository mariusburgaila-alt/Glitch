<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLITCH v5 — Focus Timer + Show One + Shortcuts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#0B0B0C] text-zinc-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* ---------- UTILS ---------- */
    function ymd(date = new Date()) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function prevYmd(){ const d=new Date(); d.setDate(d.getDate()-1); return ymd(d); }
    function useLocalState(key, initial){
      const [state,setState]=useState(()=>{ try{const v=localStorage.getItem(key); return v?JSON.parse(v):initial;}catch{ return initial; }});
      useEffect(()=>{ try{localStorage.setItem(key,JSON.stringify(state));}catch{} },[key,state]);
      return [state,setState];
    }
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

    /* ---------- CHALLENGE HELPERS ---------- */
    const CHALLENGE_TOTAL=22;
    function parseYmd(s){ const [y,m,d]=(s||"").split("-").map(Number); if(!y||!m||!d) return null; return new Date(Date.UTC(y,m-1,d)); }
    function daysBetween(a,b){ const A=parseYmd(a), B=parseYmd(b); if(!A||!B) return 0; return Math.floor((B-A)/(1000*60*60*24)); }
    function computeChallengeDay(startStr,todayStr,total=CHALLENGE_TOTAL){ const d=Math.max(0,daysBetween(startStr,todayStr)); return Math.max(1,Math.min(total,d+1)); }
    function getOrInitChallengeStart(){ try{const v=localStorage.getItem("ng.challenge.start"); if(v) return v;}catch{} const t=ymd(); try{localStorage.setItem("ng.challenge.start",t);}catch{} return t; }

    /* ---------- DATA HELPERS ---------- */
    const CORNER_DEFAULTS=[
      {id:"cc-move",text:"Move 10 minutes (walk/Zone 2)",preset:true},
      {id:"cc-breathe",text:"5 mindful breaths + one word",preset:true},
      {id:"cc-build",text:"25-min build block (highest leverage)",preset:true},
      {id:"cc-service",text:"1 micro-service (helpful ping)",preset:true},
    ];
    function generateMarkdown(dateStr,tasks,stats,dayX=null){
      const lines=[
        `# Nice Glitch — ${dateStr}${dayX?` (Day ${dayX}/${CHALLENGE_TOTAL})`:""}`,
        `Progress: ${stats.pct}% (${stats.done}/${stats.total})`,
        "",
        ...tasks.map(t => `${t.done?"- [x]":"- [ ]"} ${t.text}`)
      ];
      return lines.join("\n");
    }
    function mergeCarryOver(todayTasks, yTasks) {
      const undone=(yTasks||[]).filter(t=>!t.done);
      const merged=[...todayTasks];
      undone.forEach(t=>{
        if(!merged.some(m=>m.text===t.text)){
          merged.push({id:`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,text:t.text,done:false,createdAt:Date.now()});
        }
      });
      return merged;
    }
    function toggleById(list,id){ return list.map(x=>x.id===id?{...x,done:!x.done,completedAt:!x.done?Date.now():undefined}:x); }

    /* ---------- DECOR + UI BITS ---------- */
    function Backdrop(){
      return (<>
        <div className="absolute -top-40 -left-32 w-[44rem] h-[44rem] rounded-full bg-purple-700/25 blur-3xl" />
        <div className="absolute -bottom-40 right-0 w-[36rem] h-[36rem] rounded-full bg-emerald-500/20 blur-3xl" />
        <div className="absolute inset-0 [mask-image:radial-gradient(70%_60%_at_50%_20%,black,transparent)]"><Stars/></div>
      </>);
    }
    function Stars(){
      const dots=Array.from({length:140},(_,i)=>i);
      return (<svg className="absolute inset-0 w-full h-full">
        {dots.map(i=>(<circle key={i} cx={Math.random()*100+"%"} cy={Math.random()*100+"%"} r={(Math.random()*0.8+0.2).toFixed(2)} fill="white" opacity={Math.random()*0.6+0.1}/>))}
      </svg>);
    }
    function Glitch({children}){
      return (
        <span className="relative inline-block">
          <span className="relative z-10">{children}</span>
          <span className="absolute inset-0 -translate-x-[1px] -translate-y-[1px] text-emerald-400/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
          <span className="absolute inset-0 translate-x-[1px] translate-y-[1px] text-fuchsia-500/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
        </span>
      );
    }
    function Field({ label, hint, children }) {
      return (
        <div className="mb-3">
          <div className="flex items-center justify-between mb-1">
            <label className="text-sm text-zinc-300">{label}</label>
            {hint && <span className="text-[11px] text-zinc-500">{hint}</span>}
          </div>
          {children}
        </div>
      );
    }

    /* ---------- EVENT BUS (agent -> chat) ---------- */
    function emitAgent(text){ window.dispatchEvent(new CustomEvent("ng:agent", { detail:{ text } })); }

    /* ---------- GLITCH PERSONA ---------- */
    const GLITCH_PERSONA = `
You are GLITCH — a tough-love astronaut coach. Voice: brief, green-ink terminal,
supportive but no fluff. Prioritize action, momentum, and discipline. If user is stuck,
offer a single next step, a tiny timer, or a reframing. Prefer bullets. Avoid rambling.
`;

    /* ---------- CHAT WINDOW ---------- */
    function ChatWindow(){
      const [input,setInput]=useState("");
      const [model,setModel]=useState("gpt-4o-mini");
      const [enabled,setEnabled]=useLocalState("ng.agent.enabled", true);
      const [msgs,setMsgs]=useLocalState("ng.chat.log", [
        {who:"ai", text:"GLITCH uplink online. How can I help, operator?"}
      ]);
      const logRef=useRef(null);
      const API_BASE = location.hostname.endsWith('vercel.app') ? '' : 'https://glitch-rouge.vercel.app';

      useEffect(()=>{ if(logRef.current){ logRef.current.scrollTop=logRef.current.scrollHeight; } },[msgs]);

      useEffect(()=>{
        const h = (e)=> setMsgs(m=>[...m,{who:"ai", text:e.detail.text}]);
        window.addEventListener("ng:agent", h);
        return ()=>window.removeEventListener("ng:agent", h);
      },[]);

      async function send(){
        const t=input.trim(); if(!t) return;
        setMsgs(m=>[...m,{who:"me",text:t}]); setInput("");
        try{
          const context = msgs.slice(-12).map(m => ({ role: m.who==='ai'?'assistant':'user', content: m.text }));
          const r = await fetch(`${API_BASE}/api/chat`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              model,
              system: GLITCH_PERSONA,
              messages: [...context, { role:'user', content: t }]
            })
          });
          const data = await r.json();
          if(!r.ok){ setMsgs(m=>[...m,{who:"ai",text:`Error: ${data?.error || 'OpenAI error'}`}]); return; }
          setMsgs(m=>[...m,{who:"ai", text: (data?.content || '').trim() || '(no content)'}]);
        }catch(e){
          setMsgs(m=>[...m,{who:"ai", text:'Network error.'}]);
        }
      }

      return (
        <div className="rounded-2xl border border-zinc-800 bg-zinc-950/70 p-5 backdrop-blur flex flex-col h-full">
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm text-zinc-300">/chat — <span className="text-zinc-500">AI link</span></div>
            <div className="flex items-center gap-2">
              <label className="text-[11px] text-zinc-500 flex items-center gap-1">
                <input type="checkbox" className="accent-emerald-500" checked={enabled} onChange={e=>setEnabled(e.target.checked)} />
                Proactive
              </label>
              <select value={model} onChange={e=>setModel(e.target.value)} className="bg-zinc-900 border border-zinc-700 px-2 py-1 rounded-md text-xs">
                <option value="gpt-4o-mini">Fast (4o-mini)</option>
                <option value="gpt-5">Deep (GPT-5)</option>
              </select>
            </div>
          </div>

          <div ref={logRef} className="flex-1 overflow-auto rounded-xl border border-zinc-800 bg-black/40 p-3 space-y-2">
            {msgs.map((m,i)=>(
              <div key={i} className={`max-w-[85%] rounded-lg px-3 py-2 text-sm ${m.who==='me'
                ? 'ml-auto bg-zinc-900 text-zinc-200 border border-zinc-700'
                : 'mr-auto bg-zinc-900/40 border border-emerald-700/40 text-emerald-300'}`}>
                {m.text}
              </div>
            ))}
          </div>

          <div className="mt-3 flex gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') send(); }}
                   placeholder="Type a message…" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" />
            <button onClick={send} className="rounded-xl px-4 py-2 bg-emerald-500 text-zinc-900 text-sm font-semibold hover:bg-emerald-400 transition">Send</button>
          </div>

          <div className="mt-2 text-[11px] text-zinc-500">
            Replies in <span className="text-emerald-300">green</span>. Calls use your own <code className="font-mono">/api/chat</code>.
          </div>
        </div>
      );
    }

    /* ---------- PROACTIVE AGENT (unchanged) ---------- */
    function useProactiveAgent(tasks, enabled){
      useEffect(()=>{
        if(!enabled) return;
        const tick = () => {
          const now = Date.now();
          const DEFAULT_MIN = 30;
          const RULES = [
            { match:/move|walk|zone\s*2/i, min:10, msg:t=>`Quick win: ${t}. 10-minute Zone-2 — start now; report back ✅` },
            { match:/build|block|focus|write/i, min:25, msg:t=>`Deep block: ${t}. Set 25-minute timer. Phone down. Go.` },
            { match:/breath|breathe|mindful|meditat/i, min:10, msg:t=>`Reset nervous system: ${t}. 5 mindful breaths — in 4, hold 4, out 6.` },
            { match:/service|ping|email|reply/i, min:20, msg:t=>`Micro-service: ${t}. Send the helpful ping. One take. Ship.` },
          ];
          (tasks||[]).forEach(task=>{
            if(task.done) return;
            const created = task.createdAt || Date.now();
            const ageMin = (now - created)/60000;
            let min = DEFAULT_MIN, templ = (txt)=>`Still open: ${txt}. Pick a tiny first move; 5 minutes only.`;
            for(const r of RULES){ if(r.match.test(task.text)){ min=r.min; templ=r.msg; break; } }
            if(ageMin >= min){
              const lastKey = `ng.agent.last.${task.id}`;
              const last = Number(localStorage.getItem(lastKey) || 0);
              if(now - last > 15*60*1000){
                localStorage.setItem(lastKey, String(now));
                emitAgent( templ(task.text) );
              }
            }
          });
        };
        const id = setInterval(tick, 60*1000);
        const start = setTimeout(tick, 5000);
        return ()=>{ clearInterval(id); clearTimeout(start); };
      }, [JSON.stringify(tasks), enabled]);
    }

    /* ---------- FOCUS TIMER HOOK ---------- */
    function useFocusTimer(){
      const [state,setState]=useState({
        taskId:null, duration:0, startedAt:0, halfAnnounced:false, running:false, remaining:0
      });
      useEffect(()=>{
        if(!state.running) return;
        const id=setInterval(()=>{
          const elapsed = Math.floor((Date.now()-state.startedAt)/1000);
          const rem = clamp(state.duration - elapsed, 0, state.duration);
          setState(s=>({...s, remaining: rem }));
          // halfway ping
          if(!state.halfAnnounced && elapsed >= Math.floor(state.duration/2)){
            setState(s=>({...s, halfAnnounced:true}));
            emitAgent("Halfway. Two breaths. Stay on the same tab. Keep going.");
          }
          // finish
          if(rem<=0){
            setState(s=>({...s, running:false}));
            emitAgent("Time. Mark it done or extend 5 minutes?");
          }
        },1000);
        return ()=>clearInterval(id);
      },[state.running, state.startedAt, state.duration, state.halfAnnounced]);

      function start(taskId, minutes){
        const dur = minutes*60;
        setState({taskId, duration:dur, startedAt:Date.now(), halfAnnounced:false, running:true, remaining:dur});
        emitAgent(`Timer armed: ${minutes} minutes — focus mode.`);
      }
      function stop(){ setState(s=>({...s, running:false})); }
      return { state, start, stop, setState };
    }

    /* ---------- TODO WINDOW (+ Focus, Show One, Shortcuts) ---------- */
    function TodoWindow({ onClose, onTasksChange }){
      const today=ymd(), yesterday=prevYmd();
      const [tasks,setTasks]=useLocalState(`ng.todo.${today}` ,[]);
      const [newTask,setNewTask]=useState("");
      const [filter,setFilter]=useState("all");
      const [challengeStart,setChallengeStart]=useState(getOrInitChallengeStart());
      const [showOne,setShowOne]=useLocalState("ng.showOne", false);

      // selection + focus
      const [selectedId,setSelectedId]=useState(null);
      const [focusId,setFocusId]=useState(null);
      const addInputRef=useRef(null);

      const timer = useFocusTimer();

      // upgrade createdAt if missing
      useEffect(()=>{
        if((tasks||[]).some(t=>!t.createdAt)){ setTasks(ts=>ts.map(t=>t.createdAt? t : {...t, createdAt: Date.now()})); }
      },[]);

      // bubble task changes (for proactive agent)
      useEffect(()=>{ onTasksChange?.(tasks); },[tasks]);

      // stats
      const stats=useMemo(()=>{
        const total=tasks.length, done=tasks.filter(t=>t.done).length, open=total-done, pct=total?Math.round(done/total*100):0;
        return {total,done,open,pct};
      },[tasks]);
      const challengeDay=useMemo(()=>computeChallengeDay(challengeStart,today,CHALLENGE_TOTAL),[challengeStart,today]);

      // filtered + display list
      const filtered=tasks.filter(t=>filter==="all"?true:filter==="done"?t.done:!t.done);
      const firstOpen = tasks.find(t=>!t.done);
      const displayTasks = useMemo(()=>{
        if(timer.state.running && focusId){
          return filtered.filter(t=>t.id===focusId);
        }
        if(showOne){
          if(focusId) return filtered.filter(t=>t.id===focusId);
          return firstOpen ? filtered.filter(t=>t.id===firstOpen.id) : [];
        }
        return filtered;
      }, [filtered, showOne, focusId, timer.state.running, firstOpen?.id]);

      // ensure selected exists
      useEffect(()=>{
        if(!selectedId && displayTasks.length>0){ setSelectedId(displayTasks[0].id); }
      },[displayTasks, selectedId]);

      // actions
      function addTask(){
        const t = newTask.trim();
        if(!t) return;
        const id=`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
        setTasks([...tasks,{id,text:t,done:false,createdAt:Date.now()}]);
        setNewTask("");
        setSelectedId(id);
      }
      function toggleTask(id){ setTasks(toggleById(tasks,id)); }
      function removeTask(id){ setTasks(tasks.filter(x=>x.id!==id)); if(id===selectedId) setSelectedId(null); if(id===focusId) setFocusId(null); }
      function clearDone(){ setTasks(tasks.filter(x=>!x.done)); }
      function addCornerDefaults(){
        const incoming = CORNER_DEFAULTS
          .filter(d=>!tasks.some(t=>t.id===d.id))
          .map(d=>({id:d.id,text:d.text,done:false,preset:true,createdAt:Date.now()}));
        setTasks([...tasks,...incoming]);
      }
      function carryOverFromYesterday(){
        try{
          const raw=localStorage.getItem(`ng.todo.${yesterday}`); if(!raw) return;
          const yTasks=JSON.parse(raw)||[]; setTasks(mergeCarryOver(tasks,yTasks));
        }catch{}
      }
      async function exportMarkdown(){
        const md=generateMarkdown(today,tasks,stats,challengeDay);
        let copied=false; try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(md); copied=true; } }catch{}
        if(!copied){
          const blob=new Blob([md],{type:"text/markdown;charset=utf-8"});
          const url=URL.createObjectURL(blob), a=document.createElement("a");
          a.href=url; a.download=`nice-glitch-${today}.md`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        alert(copied?"Copied today’s tasks to clipboard as Markdown.":"Downloaded today’s tasks as .md file.");
      }
      function resetChallenge(){ const fresh=ymd(); setChallengeStart(fresh); try{localStorage.setItem("ng.challenge.start",fresh);}catch{} }

      // keyboard shortcuts
      useEffect(()=>{
        let tArmedAt = 0; // press T then 5/2 within 1200ms
        const onKey=(e)=>{
          const tag = (e.target.tagName||'').toLowerCase();
          const typing = tag==='input' || tag==='textarea' || e.isComposing;
          // N: focus add box (works anywhere)
          if(e.key.toLowerCase()==='n'){ e.preventDefault(); addInputRef.current?.focus(); return; }
          if(typing) return; // don't steal while typing
          if(e.key==='Enter'){ e.preventDefault(); addTask(); return; }
          if(e.key.toLowerCase()==='j'){ e.preventDefault(); if(displayTasks.length===0) return;
            const idx = Math.max(0, displayTasks.findIndex(t=>t.id===selectedId));
            const next = displayTasks[Math.min(idx+1, displayTasks.length-1)]; setSelectedId(next?.id || selectedId); return;
          }
          if(e.key.toLowerCase()==='k'){ e.preventDefault(); if(displayTasks.length===0) return;
            const idx = Math.max(0, displayTasks.findIndex(t=>t.id===selectedId));
            const prev = displayTasks[Math.max(idx-1,0)]; setSelectedId(prev?.id || selectedId); return;
          }
          if(e.key===' '){ e.preventDefault(); if(selectedId) toggleTask(selectedId); return; }
          if(e.key.toLowerCase()==='t'){ tArmedAt=Date.now(); return; }
          if((e.key==='5' || e.key==='2') && selectedId && Date.now()-tArmedAt<1200){
            e.preventDefault();
            setFocusId(selectedId);
            timer.start(selectedId, e.key==='5'?5:25);
            return;
          }
        };
        window.addEventListener('keydown', onKey);
        return ()=>window.removeEventListener('keydown', onKey);
      }, [displayTasks, selectedId, addTask, toggleTask]);

      // helpers
      const sel = tasks.find(t=>t.id===selectedId) || null;
      const focusTask = tasks.find(t=>t.id===focusId) || null;
      const fmt = (s)=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
      const inFocus = !!focusTask;

      // UI
      return (
        <div className="rounded-2xl border border-zinc-800 bg-zinc-950/70 p-5 backdrop-blur h-full">
          {/* Top bar */}
          <div className="flex items-center justify-between gap-2 mb-4">
            <div>
              <div className="text-sm text-zinc-300">/todo — <span className="text-zinc-400">{today}</span></div>
              <div className="text-[11px] text-zinc-500">Tasks auto-save locally. Focus wins.</div>
            </div>
            <div className="flex items-center gap-2 text-xs">
              <button onClick={addCornerDefaults} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Add Corner Defaults</button>
              <button onClick={carryOverFromYesterday} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Carry Over ⟲</button>
              <button onClick={clearDone} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Clear Done</button>
              <button onClick={()=>setShowOne(!showOne)} className={`rounded-md px-2 py-1 border ${showOne?'border-emerald-500/60 bg-emerald-500/10 text-emerald-300':'border-zinc-700 hover:bg-zinc-900 text-zinc-300'}`}>{showOne?'Show All':'Show One'}</button>
              <button onClick={exportMarkdown} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Export .md</button>
              <button onClick={onClose} className="rounded-md border border-emerald-700/60 text-emerald-300 px-2 py-1 hover:bg-emerald-950/40">Exit</button>
            </div>
          </div>

          {/* Progress + Day */}
          <div className="mb-4">
            <div className="flex items-center justify-between text-[11px] text-zinc-500 mb-1">
              <span>Progress <span className="text-zinc-400">(Day {challengeDay}/{CHALLENGE_TOTAL})</span></span>
              <span>{stats.pct}% ({stats.done}/{stats.total})</span>
            </div>
            <div className="w-full h-2 rounded-full bg-zinc-900 overflow-hidden"><div className="h-full bg-emerald-500" style={{width:`${stats.pct}%`}}/></div>
            <div className="mt-1 text-[11px] text-zinc-500 flex items-center justify-between">
              <span>Challenge start: <span className="text-zinc-400">{challengeStart}</span></span>
              <button onClick={resetChallenge} className="underline hover:text-zinc-300">reset day 1</button>
            </div>
          </div>

          {/* Focus Panel */}
          {inFocus && (
            <div className="mb-4 rounded-xl border border-emerald-700/50 bg-emerald-900/10 p-4">
              <div className="flex items-center justify-between">
                <div className="text-sm text-emerald-300 font-semibold">Focus: {focusTask?.text}</div>
                <div className="text-[11px] text-zinc-400 flex items-center gap-3">
                  {timer.state.running ? (
                    <>
                      <span>Remaining: <span className="text-emerald-300 font-mono">{fmt(timer.state.remaining)}</span></span>
                      <button onClick={()=>timer.stop()} className="px-2 py-1 rounded-md border border-zinc-700 hover:bg-zinc-900">Pause</button>
                    </>
                  ) : (
                    <>
                      <button onClick={()=>timer.start(focusId,5)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Start 5m</button>
                      <button onClick={()=>timer.start(focusId,25)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Start 25m</button>
                    </>
                  )}
                  <button onClick={()=>setFocusId(null)} className="px-2 py-1 rounded-md border border-zinc-700 hover:bg-zinc-900">Exit focus</button>
                </div>
              </div>
              <div className="mt-3 w-full h-2 rounded-full bg-emerald-950/50 overflow-hidden">
                <div className="h-full bg-emerald-500 transition-all" style={{width:`${100*(1-(timer.state.remaining||0)/(timer.state.duration||1))}%`}}/>
              </div>

              {!timer.state.running && (
                <div className="mt-3 text-[12px] text-zinc-400 flex gap-2">
                  <button onClick={()=>{ setTasks(toggleById(tasks, focusId)); setFocusId(null); }} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Mark done</button>
                  <button onClick={()=>timer.start(focusId,5)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">+5 min</button>
                </div>
              )}
            </div>
          )}

          {/* Add Task */}
          <div className="flex gap-2 mb-3">
            <input ref={addInputRef} value={newTask} onChange={e=>setNewTask(e.target.value)} onKeyDown={e=>{ if(e.key==="Enter") addTask(); }}
                   placeholder="Add a task…" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" />
            <button onClick={addTask} className="rounded-xl px-4 py-2 bg-emerald-500 text-zinc-900 text-sm font-semibold hover:bg-emerald-400 transition">Add</button>
          </div>

          {/* Filters */}
          <div className="flex items-center gap-2 text-xs mb-2">
            {[
              {id:"all",label:"All"},
              {id:"open",label:"Open"},
              {id:"done",label:"Done"},
            ].map(f=>(
              <button key={f.id} onClick={()=>setFilter(f.id)} className={`px-2 py-1 rounded-md border ${filter===f.id?'border-emerald-500/60 bg-emerald-500/10 text-emerald-300':'border-zinc-700 hover:bg-zinc-900 text-zinc-300'}`}>{f.label}</button>
            ))}
          </div>

          {/* Task list */}
          <div className="space-y-2">
            {displayTasks.length===0 && (
              <div className="text-sm text-zinc-500 border border-dashed border-zinc-700 rounded-xl p-4">No tasks here. Add one above, or <button className="underline ml-1" onClick={()=>{ setShowOne(false); }}>show all</button>.</div>
            )}
            {displayTasks.map(t=>(
              <div key={t.id}
                   onClick={()=>{ setSelectedId(t.id); setFocusId(t.id); }}
                   className={`flex items-center justify-between gap-2 rounded-xl border px-3 py-2 cursor-pointer
                     ${t.id===selectedId ? 'border-emerald-600 bg-zinc-900/70' : 'border-zinc-800 bg-zinc-900/60'}`}>
                <label className="flex items-center gap-3 cursor-pointer select-none">
                  <input type="checkbox" className="size-4 accent-emerald-500" checked={!!t.done} onChange={(e)=>{ e.stopPropagation(); toggleTask(t.id); }} />
                  <span className={`text-sm ${t.preset?"text-zinc-100":"text-zinc-300"} ${t.done?"line-through text-zinc-500":""}`}>{t.text}</span>
                </label>
                {!t.preset && (
                  <button onClick={(e)=>{ e.stopPropagation(); removeTask(t.id); }} className="text-[11px] text-zinc-500 hover:text-zinc-300">remove</button>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ---------- DIAGNOSTICS (kept) ---------- */
    function Diagnostics(){
      const results=useMemo(()=>{
        const sampleTasks=[{id:"1",text:"Task A",done:false},{id:"2",text:"Task B",done:true}];
        const sampleStats={pct:50,done:1,total:2};
        const md=generateMarkdown("2099-01-01",sampleTasks,sampleStats,5);
        const t1 = md.includes("(Day 5/22)") && md.includes("\n- [ ] Task A\n- [x] Task B") && !md.includes("\r\n");
        const yTasks=[{id:"y1",text:"A",done:true},{id:"y2",text:"B",done:false},{id:"y3",text:"C",done:false}];
        const today=[{id:"t1",text:"B",done:false}];
        const merged=mergeCarryOver(today,yTasks);
        const t2 = merged.some(m=>m.text==="B") && merged.some(m=>m.text==="C") && !merged.some(m=>m.text==="A");
        const t3 = toggleById([{id:"z",text:"Z",done:false}],"z")[0].done===true;
        const start="2025-01-01";
        const d1=computeChallengeDay(start,"2025-01-01"), d2=computeChallengeDay(start,"2025-01-02"),
              d22=computeChallengeDay(start,"2025-01-22"), dCap=computeChallengeDay(start,"2025-02-15");
        const t4 = d1===1 && d2===2 && d22===22 && dCap===22;
        const md2=generateMarkdown("2099-12-31",[],{pct:0,done:0,total:0},1);
        const t5 = md2.startsWith("# Nice Glitch — 2099-12-31 (Day 1/22)\nProgress: 0% (0/0)\n\n");
        const t6 = daysBetween("2025-01-31","2025-02-02")===2;
        return [
          {name:"Markdown includes Day X/22 and uses \\n",pass:t1},
          {name:"Carry-over merges undone, dedupes by text",pass:t2},
          {name:"toggleById flips done",pass:t3},
          {name:"Challenge day computation correct & capped",pass:t4},
          {name:"Markdown header has date + day label",pass:t5},
          {name:"daysBetween handles month change",pass:t6},
        ];
      },[]);
      const allPass=results.every(r=>r.pass);
      return (
        <div className="mt-6 rounded-xl border border-zinc-800 bg-zinc-900/60 p-3">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm text-zinc-300">Diagnostics</div>
            <div className={`text-xs ${allPass?"text-emerald-400":"text-red-400"}`}>{allPass?"All tests passed":"Some tests failed"}</div>
          </div>
          <ul className="text-[12px] space-y-1">
            {results.map((r,i)=>(
              <li key={i} className={r.pass?"text-emerald-300":"text-red-300"}>{r.pass?"✓":"✗"} {r.name}</li>
            ))}
          </ul>
        </div>
      );
    }

    /* ---------- MAIN APP ---------- */
    function App(){
      const [agentEnabled] = useLocalState("ng.agent.enabled", true);
      const [liveTasks,setLiveTasks] = useState([]);

      useProactiveAgent(liveTasks, agentEnabled);

      return (
        <div className="relative min-h-screen overflow-hidden">
          <Backdrop/>
          <div className="relative z-10 mx-auto max-w-6xl px-4 pt-14 pb-16">
            <div className="text-center mb-8 select-none">
              <div className="inline-grid place-items-center size-16 rounded-2xl bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-purple-600 via-fuchsia-500 to-emerald-400 shadow-lg shadow-purple-900/30 border border-white/10">
                <span className="font-black tracking-wider text-white">NG</span>
              </div>
              <h1 className="mt-4 text-3xl md:text-4xl font-extrabold tracking-tight">
                <span className="relative inline-block"><Glitch>Nice Glitch</Glitch></span>
              </h1>
              <p className="mt-1 text-zinc-400 text-sm">Exact Corner Event // Fracture Window ▸ Secret Access</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <TodoWindow onClose={()=>{}} onTasksChange={setLiveTasks}/>
              <div className="min-h-[28rem]"><ChatWindow/></div>
            </div>

            <Diagnostics/>
            <footer className="mt-8 text-center text-[11px] text-zinc-500">
              © {new Date().getFullYear()} Nice Glitch — <span className="text-zinc-300">Make the corner. Get the note.</span>
            </footer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
