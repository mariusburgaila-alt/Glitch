<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLITCH v6 ‚Äî Stable + Stats + Random</title>

  <!-- Tailwind (CDN for now) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pinned libs -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

  <style>
    html,body { background:#0B0B0C; color:#E4E4E7; }
    .card{ border:1px solid #27272a; background:rgba(9,9,11,.7); border-radius:1rem; }
    .btn{ border:1px solid #3f3f46; padding:.5rem .75rem; border-radius:.5rem; }
    .btn:hover{ background:#18181b; }
    .btn-cta{ background:#34D399; color:#0B0B0C; border:none; }
    .btn-cta:hover{ filter:brightness(1.05); }
    .chip{ font-size:.7rem; color:#a1a1aa; border:1px solid #3f3f46; border-radius:.375rem; padding:.15rem .4rem }
    .ng-green{ color:#34D399; }
    table.ng { width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums; }
    table.ng th, table.ng td { border-bottom:1px solid #27272a; padding:.5rem .5rem; }
    table.ng thead th { position:sticky; top:0; background:#0b0b0cEE; }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState} = React;

    /* ---------------- core utils & storage guards ---------------- */
    const TODAY_STR = ymd();

    function ymd(date=new Date()){
      const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,"0"), d=String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function prevYmd(){ const d=new Date(); d.setDate(d.getDate()-1); return ymd(d); }
    function parseYmd(s){ const [y,m,d]=(s||"").split("-").map(Number); if(!y||!m||!d) return null; return new Date(Date.UTC(y,m-1,d)); }
    function daysBetween(a,b){ const A=parseYmd(a),B=parseYmd(b); if(!A||!B) return 0; return Math.floor((B-A)/(1000*60*60*24)); }

    const CHALLENGE_TOTAL=22;

    function safeParse(json, fb){ try{ return JSON.parse(json); }catch{ return fb; } }
    function safeGet(key, fb){ try{ const v=localStorage.getItem(key); return v==null?fb:safeParse(v,fb); }catch{ return fb; } }
    function safeSet(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
    function clearPrefix(prefix){
      try{
        const del=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k?.startsWith(prefix)) del.push(k); }
        del.forEach(k=>localStorage.removeItem(k));
      }catch{}
    }
    function useLocalState(key, initial){
      const [state,setState]=useState(()=>safeGet(key,initial));
      useEffect(()=>{ safeSet(key,state); },[key,state]);
      return [state,setState];
    }
    function getOrInitChallengeStart(){
      const k="ng.challenge.start"; const v=safeGet(k,null);
      if(v) return v; safeSet(k, TODAY_STR); return TODAY_STR;
    }
    function computeChallengeDay(startStr, todayStr=TODAY_STR, total=CHALLENGE_TOTAL){
      const d=Math.max(0, daysBetween(startStr, todayStr)); return Math.max(1, Math.min(total, d+1));
    }
    const CORNER_DEFAULTS=[
      {id:"cc-move",text:"Move 10 minutes (walk/Zone 2)",preset:true},
      {id:"cc-breathe",text:"5 mindful breaths + one word",preset:true},
      {id:"cc-build",text:"25-min build block (highest leverage)",preset:true},
      {id:"cc-service",text:"1 micro-service (helpful ping)",preset:true},
    ];
    function mergeCarryOver(todayTasks,yTasks){
      const undone=(yTasks||[]).filter(t=>!t.done); const merged=[...todayTasks];
      undone.forEach(t=>{ if(!merged.some(m=>m.text===t.text)){ merged.push({id:`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`, text:t.text, done:false}); }});
      return merged;
    }
    function toggleById(list,id){ return list.map(x=>x.id===id?{...x,done:!x.done}:x); }

    /* ---------------- error bus ---------------- */
    const GlobalErrors={
      push(msg){ const list=safeGet("ng.errors",[]); list.unshift({ts:Date.now(), msg:String(msg).slice(0,500)}); safeSet("ng.errors", list.slice(0,50)); window.dispatchEvent(new CustomEvent("ng:errors")); },
      use(){ const [errs,setErrs]=useState(()=>safeGet("ng.errors",[])); useEffect(()=>{ const h=()=>setErrs(safeGet("ng.errors",[])); window.addEventListener("ng:errors",h); return ()=>window.removeEventListener("ng:errors",h); },[]); return errs; }
    };
    window.onerror=(m,src,ln,col,err)=>GlobalErrors.push(err?.stack||m||"Unknown error");
    window.onunhandledrejection=(e)=>GlobalErrors.push(e?.reason?.stack||e?.reason||"Unhandled rejection");

    /* ---------------- hash routing ---------------- */
    function useHashRoute(){
      const pick=()=>location.hash.replace(/^#\/?/,'')||"dashboard";
      const [route,setRoute]=useState(pick);
      useEffect(()=>{ const on=()=>setRoute(pick()); window.addEventListener("hashchange",on); if(!location.hash) location.hash="#/dashboard"; return ()=>window.removeEventListener("hashchange",on); },[]);
      return [route,(r)=>{ location.hash=`#/${r}`; }];
    }

    /* ---------------- app ---------------- */
    function App(){
      const [route,goto]=useHashRoute();
      const [proactive,setProactive]=useLocalState("ng.proactive", false);

      return (
        <div className="max-w-6xl mx-auto px-4 py-6 space-y-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="size-9 rounded-xl bg-gradient-to-br from-purple-600 via-fuchsia-500 to-emerald-400 grid place-items-center text-[11px] font-black">NG</div>
              <div className="text-zinc-200 font-semibold tracking-tight">Nice Glitch</div>
              <span className="chip">v6 stable</span>
            </div>

            <div className="flex items-center gap-2">
              <button className={`btn ${route==='dashboard'?'bg-zinc-800':''}`} onClick={()=>goto('dashboard')}>Dashboard</button>
              <button className={`btn ${route==='chat'?'bg-zinc-800':''}`} onClick={()=>goto('chat')}>Chat</button>
              <button className={`btn ${route==='stats'?'bg-zinc-800':''}`} onClick={()=>goto('stats')}>Stats</button>

              <label className="inline-flex items-center gap-2 ml-2 text-sm text-zinc-400">
                <input type="checkbox" className="accent-emerald-500" checked={!!proactive} onChange={e=>setProactive(e.target.checked)} />
                Proactive
              </label>

              <button className="btn" title="Clear only ng.* keys" onClick={()=>{ if(confirm("Hard Reset (clears local NG data only)?")){ clearPrefix("ng."); location.reload(); }}}>Hard Reset</button>
            </div>
          </div>

          {route==='dashboard' && <Dashboard/>}
          {route==='chat' && <ChatScreen proactive={proactive} onBack={()=>goto('dashboard')}/>}
          {route==='stats' && <StatsScreen onBack={()=>goto('dashboard')}/>}

          <Diagnostics/>
        </div>
      );
    }

    function Dashboard(){
      return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <TodoCard />
          <HintsCard />
        </div>
      );
    }

    function HintsCard(){
      return (
        <section className="card p-4 space-y-3">
          <div className="text-sm text-zinc-300 font-semibold">Shortcuts & Tips</div>
          <ul className="text-sm list-disc pl-5 text-zinc-400 space-y-1">
            <li><span className="chip">N</span> focuses ‚ÄúAdd a task‚Ä¶‚Äù</li>
            <li><span className="chip">J/K</span> move ‚Ä¢ <span className="chip">Space</span> toggle</li>
            <li><span className="chip">T</span> then <span className="chip">5</span>/<span className="chip">2</span> ‚Üí 5/25m focus timer (coming back later)</li>
            <li>Export/Import **.json** for backups; **.md** for notes</li>
          </ul>
        </section>
      );
    }

    /* ---------------- Todo (+ RANDOM SCRATCH) ---------------- */
    function TodoCard(){
      const today=TODAY_STR, yesterday=prevYmd();
      const [tasks,setTasks]=useLocalState(`ng.todo.${today}`,[]);
      const [newTask,setNewTask]=useState("");
      const [filter,setFilter]=useState("all");
      const [challengeStart,setChallengeStart]=useState(getOrInitChallengeStart());

      // Random scratch modal
      const [scratchOpen,setScratchOpen]=useState(false);
      const [scratchTask,setScratchTask]=useState(null);

      useEffect(()=>{ if((tasks||[]).some(t=>!t.createdAt)){ setTasks(ts=>ts.map(t=>t.createdAt?t:{...t,createdAt:Date.now()})); } },[]);

      const stats=useMemo(()=>{ const total=tasks.length, done=tasks.filter(t=>t.done).length, open=total-done; return {total,done,open,pct:total?Math.round(done/total*100):0}; },[tasks]);
      const challengeDay=useMemo(()=>computeChallengeDay(challengeStart, today),[challengeStart]);

      function addTask(){ const t=newTask.trim(); if(!t) return; const id=`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`; setTasks([{id,text:t,done:false,createdAt:Date.now()}, ...tasks]); setNewTask(""); }
      function toggleTask(id){ setTasks(toggleById(tasks,id)); }
      function removeTask(id){ setTasks(tasks.filter(x=>x.id!==id)); }
      function clearDone(){ setTasks(tasks.filter(x=>!x.done)); }
      function addCornerDefaults(){ const incoming=CORNER_DEFAULTS.filter(d=>!tasks.some(t=>t.id===d.id)).map(d=>({id:d.id,text:d.text,done:false,preset:true,createdAt:Date.now()})); setTasks([...incoming, ...tasks]); }
      function carryOver(){ try{ const raw=localStorage.getItem(`ng.todo.${yesterday}`); if(!raw) return; const y=safeParse(raw,[]); setTasks(mergeCarryOver(tasks,y)); }catch{} }
      async function exportMarkdown(){ const md=[`# Nice Glitch ‚Äî ${today} (Day ${challengeDay}/${CHALLENGE_TOTAL})`,`Progress: ${stats.pct}% (${stats.done}/${stats.total})`,"",...tasks.map(t=>`${t.done?"- [x]":"- [ ]"} ${t.text}`)].join("\n"); try{ await navigator.clipboard.writeText(md); alert("Copied Markdown."); }catch{ const blob=new Blob([md],{type:"text/markdown"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`nice-glitch-${today}.md`; a.click(); URL.revokeObjectURL(url); } }

      const filtered=tasks.filter(t=>filter==="all"?true:filter==="done"?t.done:!t.done);

      // RANDOM pick + open scratch modal
      function randomOpen(){
        const open = tasks.filter(t=>!t.done);
        if(open.length===0){ alert("All clear. No open tasks!"); return; }
        const pick = open[Math.floor(Math.random()*open.length)];
        setScratchTask(pick);
        setScratchOpen(true);
      }
      function markScratchDone(){
        if(scratchTask){ setTasks(toggleById(tasks, scratchTask.id)); }
        setScratchOpen(false);
      }
      function another(){
        // avoid repeating the same task if possible
        const open=tasks.filter(t=>!t.done && t.id!==scratchTask?.id);
        if(open.length===0){ setScratchOpen(false); return; }
        const pick=open[Math.floor(Math.random()*open.length)];
        setScratchTask(pick);
      }

      return (
        <section className="card p-5 space-y-4">
          <div className="flex items-end justify-between gap-4">
            <div>
              <div className="text-sm font-semibold text-zinc-200">/todo ‚Äî <span className="text-zinc-400">{today}</span></div>
              <div className="text-[11px] text-zinc-500">Tasks auto-save locally. Tip: add Corner Conditions first.</div>
            </div>
            <div className="flex flex-wrap items-center gap-2 text-xs">
              <button className="btn" onClick={addCornerDefaults}>Add Corner Defaults</button>
              <button className="btn" onClick={carryOver}>Carry Over ‚ü≤</button>
              <button className="btn" onClick={clearDone}>Clear Done</button>
              <button className="btn" onClick={exportMarkdown}>Export .md</button>
            </div>
          </div>

          <div>
            <div className="flex items-center justify-between text-[11px] text-zinc-500 mb-1">
              <span>Progress <span className="text-zinc-400">(Day {challengeDay}/{CHALLENGE_TOTAL})</span></span>
              <span>{stats.pct}% ({stats.done}/{stats.total})</span>
            </div>
            <div className="w-full h-2 rounded-full bg-zinc-900 overflow-hidden">
              <div className="h-full bg-emerald-500 transition-all" style={{width:`${stats.pct}%`}}></div>
            </div>
            <div className="mt-1 text-[11px] text-zinc-500 flex items-center justify-between">
              <span>Challenge start: <span className="text-zinc-400">{getOrInitChallengeStart()}</span></span>
              <button className="underline hover:text-zinc-300" onClick={()=>{ const fresh=TODAY_STR; safeSet("ng.challenge.start",fresh); location.reload(); }}>reset day 1</button>
            </div>
          </div>

          {/* add */}
          <div className="flex gap-2">
            <input value={newTask} onChange={e=>setNewTask(e.target.value)} onKeyDown={e=>{ if(e.key==="Enter") addTask(); }} placeholder="Add a task‚Ä¶" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500"/>
            <button className="btn-cta rounded-xl px-4" onClick={addTask}>Add</button>
          </div>

          {/* filters + RANDOM */}
          <div className="flex items-center gap-2 text-xs">
            {["all","open","done"].map(id=>(
              <button key={id} className={`btn ${filter===id?'border-emerald-500/60 bg-emerald-500/10 text-emerald-300':''}`} onClick={()=>setFilter(id)}>{id[0].toUpperCase()+id.slice(1)}</button>
            ))}
            <button className="btn border-emerald-600/60 text-emerald-300 hover:bg-emerald-950/20" onClick={randomOpen}>Random üé≤</button>
          </div>

          {/* list */}
          <div className="space-y-2 max-h-[380px] overflow-y-auto pr-1">
            {filtered.length===0 && (
              <div className="text-sm text-zinc-500 border border-dashed border-zinc-700 rounded-xl p-4">
                No tasks here. Add one above, or <button className="underline ml-1" onClick={addCornerDefaults}>insert Corner Defaults</button>.
              </div>
            )}
            {filtered.map(t=>(
              <div key={t.id} className="flex items-center justify-between gap-2 rounded-xl border border-zinc-800 bg-zinc-900/60 px-3 py-2">
                <label className="flex items-center gap-3 cursor-pointer select-none">
                  <input type="checkbox" className="size-4 accent-emerald-500" checked={!!t.done} onChange={()=>toggleTask(t.id)} />
                  <span className={`text-sm ${t.preset?"text-zinc-100":"text-zinc-300"} ${t.done?"line-through text-zinc-500":""}`}>{t.text}</span>
                </label>
                {!t.preset && (
                  <button className="text-[11px] text-zinc-500 hover:text-zinc-300" onClick={()=>removeTask(t.id)}>remove</button>
                )}
              </div>
            ))}
          </div>

          {/* Scratch-off modal */}
          {scratchOpen && scratchTask && (
            <ScratchCardModal
              text={scratchTask.text}
              onClose={()=>setScratchOpen(false)}
              onDone={markScratchDone}
              onAnother={another}
            />
          )}
        </section>
      );
    }

    /* ---------------- Scratch Card Modal ---------------- */
    function ScratchCardModal({ text, onClose, onDone, onAnother }){
      const canvasRef = useRef(null);
      const wrapRef = useRef(null);
      const [revealed,setRevealed]=useState(false);
      const strokeCountRef = useRef(0);
      const drawingRef = useRef(false);

      useEffect(()=>{
        const canvas = canvasRef.current;
        const wrap = wrapRef.current;
        if(!canvas || !wrap) return;

        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const W = wrap.clientWidth;
        const H = 200;
        canvas.width = Math.floor(W * dpr);
        canvas.height = Math.floor(H * dpr);
        canvas.style.width = `${W}px`;
        canvas.style.height = `${H}px`;

        const ctx = canvas.getContext('2d');
        // foil cover
        const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grad.addColorStop(0, '#475569'); // slate
        grad.addColorStop(1, '#1f2937'); // gray-800
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width,canvas.height);

        // shimmer lines
        ctx.globalCompositeOperation = 'source-over';
        for(let i=0;i<10;i++){
          ctx.strokeStyle = 'rgba(255,255,255,0.05)';
          ctx.lineWidth = 4 * dpr;
          ctx.beginPath();
          ctx.moveTo(Math.random()*canvas.width, 0);
          ctx.lineTo(Math.random()*canvas.width, canvas.height);
          ctx.stroke();
        }

        ctx.globalCompositeOperation = 'destination-out';

        function scratch(x,y){
          const r = 18 * dpr;
          ctx.beginPath();
          ctx.arc(x,y,r,0,Math.PI*2);
          ctx.fill();
          strokeCountRef.current++;
          if(strokeCountRef.current % 12 === 0){ // throttle sampling
            try {
              const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
              let cleared = 0;
              for(let i=3;i<data.length;i+=4){ if(data[i]===0) cleared++; }
              const ratio = cleared / (canvas.width*canvas.height);
              if(ratio > 0.5) setRevealed(true);
            } catch(e) {}
          }
        }

        function getXY(evt){
          const rect = canvas.getBoundingClientRect();
          const x = (evt.touches?evt.touches[0].clientX:evt.clientX) - rect.left;
          const y = (evt.touches?evt.touches[0].clientY:evt.clientY) - rect.top;
          return [x * dpr, y * dpr];
        }

        function down(e){ e.preventDefault(); drawingRef.current=true; const [x,y]=getXY(e); scratch(x,y); }
        function move(e){ if(!drawingRef.current) return; e.preventDefault(); const [x,y]=getXY(e); scratch(x,y); }
        function up(){ drawingRef.current=false; }

        canvas.addEventListener('mousedown',down); window.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
        canvas.addEventListener('touchstart',down,{passive:false}); window.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',up);

        return ()=>{
          canvas.removeEventListener('mousedown',down); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);
          canvas.removeEventListener('touchstart',down); window.removeEventListener('touchmove',move); window.removeEventListener('touchend',up);
        };
      },[]);

      return (
        <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm grid place-items-center p-4">
          <div className="w-full max-w-xl">
            <div className="rounded-2xl border border-emerald-700/40 bg-gradient-to-br from-emerald-950/60 via-zinc-950/60 to-zinc-950 p-4">
              <div className="flex items-center justify-between mb-3">
                <div className="text-sm font-semibold text-emerald-300">Scratch to reveal your mission</div>
                <button className="text-xs text-zinc-400 hover:text-zinc-200" onClick={onClose}>Close</button>
              </div>

              <div ref={wrapRef} className="relative rounded-xl border border-zinc-800 bg-black/40 overflow-hidden">
                <div className="p-4">
                  <div className={`text-center text-lg font-semibold transition ${revealed?'text-emerald-300':'text-zinc-500'}`}>
                    {revealed ? text : "‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.  scratch here  ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.."}
                  </div>
                </div>

                {!revealed && (
                  <canvas ref={canvasRef} className="absolute inset-0 w-full h-[200px]"></canvas>
                )}
              </div>

              <div className="mt-4 flex flex-wrap items-center gap-2">
                <button className="btn-cta rounded-xl px-4 py-2" onClick={onDone}>Mark done</button>
                <button className="btn rounded-xl px-3 py-2" onClick={onAnother}>Another</button>
                <button className="btn rounded-xl px-3 py-2" onClick={onClose}>Close</button>
                {!revealed && <span className="text-xs text-zinc-500">Reveal at least 50% to see it ‚ú®</span>}
              </div>
            </div>
          </div>
        </div>
      );
    }

    /* ---------------- Chat ---------------- */
    function ChatScreen({proactive,onBack}){
      const [model,setModel]=useLocalState("ng.chat.model","gpt-4o-mini");
      const [msgs,setMsgs]=useLocalState("ng.chat.msgs",[]);
      const [input,setInput]=useState("");
      async function send(){
        const text=input.trim(); if(!text) return;
        const mine={role:"user",text,ts:Date.now()}; setMsgs([...msgs,mine]); setInput("");
        try{
          const r=await fetch("/api/chat",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({model,input:text}) });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const j=await r.json();
          const ai={role:"assistant",text:String(j.output_text||j.text||"(no content)"),ts:Date.now()};
          setMsgs(m=>[...m,ai]);
        }catch(err){
          GlobalErrors.push(err);
          setMsgs(m=>[...m,{role:"assistant",text:"(API error; check /api/chat + key)",ts:Date.now()}]);
        }
      }
      return (
        <section className="card p-5 space-y-4">
          <div className="flex items-center justify-between">
            <div className="text-sm font-semibold text-zinc-200">/chat ‚Äî AI link</div>
            <div className="flex items-center gap-2">
              <select className="bg-black/40 border border-zinc-700 rounded-md px-2 py-1 text-sm" value={model} onChange={e=>setModel(e.target.value)}>
                <option>gpt-4o-mini</option><option>gpt-4.1-mini</option><option>gpt-5-nano</option>
              </select>
              <button className="btn" onClick={onBack}>Back to dashboard</button>
            </div>
          </div>
          <div className="space-y-3 max-h-[470px] overflow-y-auto pr-1">
            {msgs.map((m,i)=>(
              <div key={i} className={`rounded-xl px-3 py-2 ${m.role==='assistant'?'bg-black/30':'bg-zinc-900/60'}`}>
                <div className={`text-sm ${m.role==='assistant'?'ng-green':'text-zinc-200'}`}>{m.text}</div>
              </div>
            ))}
          </div>
          <div className="flex gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') send(); }} placeholder="Type a message‚Ä¶" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500"/>
            <button className="btn-cta rounded-xl px-4" onClick={send}>Send</button>
          </div>
          <div className="text-[11px] text-zinc-500">Replies in <span className="ng-green">green</span>. Calls use your own <code>/api/chat</code>.</div>
        </section>
      );
    }

    /* ---------------- Stats ---------------- */
    function StatsScreen({onBack}){
      const [hideZero,setHideZero]=useLocalState("ng.stats.hideZero", true);
      const [rows,setRows]=useState(()=>scanDays(hideZero));
      function refresh(){ setRows(scanDays(hideZero)); }
      useEffect(()=>{ setRows(scanDays(hideZero)); },[hideZero]);
      function exportCSV(){
        const head=["date","total","done","pct"];
        const body=rows.map(r=>[r.date,r.total,r.done,`${r.pct}`]);
        const csv=[head.join(","), ...body.map(a=>a.join(","))].join("\n");
        const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download="ng-stats.csv"; a.click(); URL.revokeObjectURL(url);
      }
      return (
        <section className="card p-5 space-y-4">
          <div className="flex items-center justify-between gap-2">
            <div className="text-sm font-semibold text-zinc-200">/stats ‚Äî Daily completion</div>
            <div className="flex items-center gap-2">
              <label className="text-sm text-zinc-400 inline-flex items-center gap-2">
                <input type="checkbox" className="accent-emerald-500" checked={!!hideZero} onChange={e=>setHideZero(e.target.checked)} />
                Hide zero-task days
              </label>
              <button className="btn" onClick={refresh}>Refresh</button>
              <button className="btn" onClick={exportCSV}>Export CSV</button>
              <button className="btn" onClick={onBack}>Back</button>
            </div>
          </div>

          <div className="rounded-xl border border-zinc-800 overflow-hidden">
            <div className="max-h-[520px] overflow-auto">
              <table className="ng text-sm">
                <thead>
                  <tr className="text-zinc-400">
                    <th className="text-left">Date</th>
                    <th className="text-right">Total</th>
                    <th className="text-right">Done</th>
                    <th className="text-right">% Done</th>
                  </tr>
                </thead>
                <tbody>
                  {rows.map(r=>(
                    <tr key={r.date}>
                      <td className="text-zinc-200">{r.date}</td>
                      <td className="text-right">{r.total}</td>
                      <td className="text-right">{r.done}</td>
                      <td className="text-right">{r.pct}%</td>
                    </tr>
                  ))}
                  {rows.length===0 && (
                    <tr><td colSpan="4" className="text-center py-6 text-zinc-500">No data yet.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </section>
      );
    }
    function scanDays(hideZero){
      const out=[];
      try{
        for(let i=0;i<localStorage.length;i++){
          const k=localStorage.key(i);
          if(!k?.startsWith("ng.todo.")) continue;
          const date=k.slice("ng.todo.".length);
          const tasks=safeGet(k,[]);
          const total=Array.isArray(tasks)?tasks.length:0;
          const done=Array.isArray(tasks)?tasks.filter(t=>t?.done).length:0;
          const pct = total?Math.round((done/total)*100):0;
          if(hideZero && total===0) continue;
          out.push({date,total,done,pct});
        }
      }catch(e){ GlobalErrors.push(e); }
      out.sort((a,b)=> (a.date<b.date?1:-1));
      return out;
    }

    /* ---------------- Diagnostics ---------------- */
    function Diagnostics(){
      const results=useMemo(()=>{
        const md=`# Nice Glitch ‚Äî 2099-01-01 (Day 5/22)\nProgress: 50% (1/2)\n\n- [ ] Task A\n- [x] Task B`;
        const t1=md.includes("(Day 5/22)")&&md.includes("\n- [ ] Task A\n- [x] Task B");
        const merged=mergeCarryOver([{id:"t1",text:"B",done:false}],[{text:"A",done:true},{text:"B",done:false},{text:"C",done:false}]);
        const t2=merged.some(m=>m.text==="B")&&merged.some(m=>m.text==="C")&&!merged.some(m=>m.text==="A");
        const t3=toggleById([{id:"z",text:"Z",done:false}],"z")[0].done===true;
        const t4=computeChallengeDay("2025-01-01","2025-01-22")===22 && computeChallengeDay("2025-01-01","2025-02-20")===22;
        const t5=daysBetween("2025-01-31","2025-02-02")===2;
        return [
          {name:"Markdown join + Day X/22",pass:t1},
          {name:"Carry-over merges undone",pass:t2},
          {name:"toggleById flips",pass:t3},
          {name:"Challenge capped at 22",pass:t4},
          {name:"daysBetween month change",pass:t5},
        ];
      },[]);
      const errs=GlobalErrors.use();
      const allPass=results.every(r=>r.pass);
      return (
        <section className="card p-4 mt-2">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm text-zinc-300">Diagnostics</div>
            <div className={`text-xs ${allPass?'text-emerald-400':'text-amber-400'}`}>{allPass?"All tests passed":"Some tests failed"}</div>
          </div>
          <ul className="text-[12px] space-y-1 mb-3">
            {results.map((r,i)=>(<li key={i} className={r.pass?"text-emerald-300":"text-amber-300"}>{r.pass?"‚úì":"‚Ä¢"} {r.name}</li>))}
          </ul>
          <div className="text-xs text-zinc-400 mb-1">Runtime errors (latest first)</div>
          <div className="rounded-lg bg-black/30 border border-zinc-800 p-2 max-h-40 overflow-y-auto text-[11px] text-zinc-400">
            {errs.length===0 ? <div className="opacity-60">None</div> :
              errs.map((e,i)=>(<div key={i} className="mb-1">{new Date(e.ts).toLocaleTimeString()} ‚Äî {e.msg}</div>))}
          </div>
        </section>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
