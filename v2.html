import React, { useEffect, useMemo, useState } from "react";

// NICE GLITCH — Secret Terminal + /todo window (single-file React)
// Tailwind CSS available by default. All data persists to localStorage.
// Added: 22‑day challenge counter (Day X/22) that auto‑increments daily from first use.
// Also: fixed exportMarkdown join("\n"), clipboard fallback, and diagnostics tests.

// ---- Utilities ----
function ymd(date = new Date()) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}
function prevYmd() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return ymd(d);
}
function useLocalState(key, initial) {
  const [state, setState] = useState(() => {
    try {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {}
  }, [key, state]);
  return [state, setState];
}

// ---- Challenge helpers ----
const CHALLENGE_TOTAL = 22;
function parseYmd(s) {
  const [y, m, d] = (s || "").split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(Date.UTC(y, m - 1, d));
}
function daysBetween(startStr, endStr) {
  const a = parseYmd(startStr);
  const b = parseYmd(endStr);
  if (!a || !b) return 0;
  const ms = b.getTime() - a.getTime();
  return Math.floor(ms / (1000 * 60 * 60 * 24));
}
function computeChallengeDay(startStr, todayStr, total = CHALLENGE_TOTAL) {
  const delta = Math.max(0, daysBetween(startStr, todayStr));
  return Math.max(1, Math.min(total, delta + 1));
}
function getOrInitChallengeStart() {
  try {
    const v = localStorage.getItem("ng.challenge.start");
    if (v) return v; // stored as plain string
  } catch {}
  const todayStr = ymd();
  try {
    localStorage.setItem("ng.challenge.start", todayStr);
  } catch {}
  return todayStr;
}

// ---- Default Corner Conditions (optional quick-add) ----
const CORNER_DEFAULTS = [
  { id: "cc-move", text: "Move 10 minutes (walk/Zone 2)", preset: true },
  { id: "cc-breathe", text: "5 mindful breaths + one word", preset: true },
  { id: "cc-build", text: "25‑min build block (highest leverage)", preset: true },
  { id: "cc-service", text: "1 micro‑service (helpful ping)", preset: true },
];

// ---- Pure helpers (testable) ----
function generateMarkdown(dateStr, tasks, stats, dayX = null) {
  const lines = [
    `# Nice Glitch — ${dateStr}${dayX ? ` (Day ${dayX}/${CHALLENGE_TOTAL})` : ""}`,
    `Progress: ${stats.pct}% (${stats.done}/${stats.total})`,
    "",
    ...tasks.map((t) => `${t.done ? "- [x]" : "- [ ]"} ${t.text}`),
  ];
  return lines.join("\n");
}
function mergeCarryOver(todayTasks, yesterdayTasks) {
  const undone = (yesterdayTasks || []).filter((t) => !t.done);
  const merged = [...todayTasks];
  undone.forEach((t) => {
    if (!merged.some((m) => m.text === t.text)) {
      merged.push({ id: `t-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`, text: t.text, done: false });
    }
  });
  return merged;
}
function toggleById(list, id) {
  return list.map((x) => (x.id === id ? { ...x, done: !x.done } : x));
}

export default function NiceGlitchTerminal() {
  const [handle, setHandle] = useState("");
  const [pass, setPass] = useState("");
  const [token, setToken] = useState("");
  const [entropy, setEntropy] = useState(0);
  const [active, setActive] = useState("login"); // login | terminal | todo

  useEffect(() => {
    const score = Math.min(100, Math.floor(((handle.length * 7 + pass.length * 11 + token.length * 13) % 101)));
    setEntropy(score);
  }, [handle, pass, token]);

  function submit(e) {
    e?.preventDefault();
    setActive("terminal");
  }

  return (
    <div className="relative min-h-screen bg-[#0B0B0C] text-zinc-100 overflow-hidden">
      <Backdrop />

      <div className="relative z-10 mx-auto max-w-md px-4 pt-20 pb-16">
        <div className="text-center mb-8 select-none">
          <div className="inline-grid place-items-center size-16 rounded-2xl bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-purple-600 via-fuchsia-500 to-emerald-400 shadow-lg shadow-purple-900/30 border border-white/10">
            <span className="font-black tracking-wider text-white">NG</span>
          </div>
          <h1 className="mt-4 text-3xl font-extrabold tracking-tight">
            <span className="relative inline-block"><Glitch>Nice Glitch</Glitch></span>
          </h1>
          <p className="mt-1 text-zinc-400 text-sm">Exact Corner Event // Fracture Window ▸ Secret Access</p>
        </div>

        {active === "login" && (
          <form onSubmit={submit} className="rounded-2xl border border-zinc-800 bg-zinc-950/60 p-5 backdrop-blur">
            <div className="mb-4 rounded-lg bg-zinc-900/60 border border-zinc-800 p-3 font-mono text-[12px] leading-relaxed text-zinc-300">
              ┌─ uplink://corner ▸ <span className="text-emerald-400">waiting_for_exact_corner</span> ─┐<br />
              │ tip: meet Corner Conditions before requesting notes. │<br />
              └──────────────────────────────────────────────────────┘
            </div>

            <Field label="Handle" hint="your operator name">
              <input value={handle} onChange={(e) => setHandle(e.target.value)} autoFocus className="w-full rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" placeholder="stardust" />
            </Field>
            <Field label="Passphrase" hint="not validated yet">
              <input value={pass} onChange={(e) => setPass(e.target.value)} type="password" className="w-full rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" placeholder="••••••••" />
            </Field>
            <Field label="Uplink Token" hint="optional">
              <input value={token} onChange={(e) => setToken(e.target.value)} className="w-full rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" placeholder="NG-CRC7-XXXX" />
            </Field>

            <div className="mt-4 mb-5">
              <div className="flex items-center justify-between text-[11px] text-zinc-500 mb-1">
                <span>Signal Entropy</span>
                <span>{entropy}%</span>
              </div>
              <div className="w-full h-2 rounded-full bg-zinc-900 overflow-hidden">
                <div className="h-full bg-emerald-500 transition-all" style={{ width: `${entropy}%` }} />
              </div>
            </div>

            <button type="submit" className="w-full rounded-xl bg-emerald-400 text-zinc-900 font-semibold py-2.5 hover:bg-emerald-300 transition">Enter Terminal</button>
            <div className="mt-3 text-[11px] text-zinc-500 text-center">By continuing you accept the <span className="text-zinc-300">Evidence Pact</span> and <span className="text-zinc-300">No Gurus Rule</span>.</div>
          </form>
        )}

        {active === "terminal" && <AccessGranted onOpenTodo={() => setActive("todo")} />}
        {active === "todo" && <TodoWindow onClose={() => setActive("terminal")} />}

        <footer className="mt-10 text-center text-[11px] text-zinc-500">
          © {new Date().getFullYear()} Nice Glitch — <span className="text-zinc-300">Make the corner. Get the note.</span>
        </footer>
      </div>

      <div className="pointer-events-none fixed inset-0 opacity-[0.08]" style={{ backgroundImage: "repeating-linear-gradient(0deg, rgba(255,255,255,0.2) 0, rgba(255,255,255,0.2) 1px, transparent 1px, transparent 3px)" }} />
    </div>
  );
}

function Field({ label, hint, children }) {
  return (
    <div className="mb-3">
      <div className="flex items-center justify-between mb-1">
        <label className="text-sm text-zinc-300">{label}</label>
        {hint && <span className="text-[11px] text-zinc-500">{hint}</span>}
      </div>
      {children}
    </div>
  );
}

function AccessGranted({ onOpenTodo }) {
  return (
    <div className="rounded-2xl border border-emerald-700/40 bg-emerald-900/10 p-5 backdrop-blur">
      <div className="flex items-center gap-2 text-emerald-300 mb-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" className="shrink-0"><path d="M20 7L9 18l-5-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
        <span className="font-semibold">Access Granted</span>
      </div>
      <p className="text-sm text-zinc-300 mb-4">Welcome, Operator. The Fracture Window is stable. Choose a module:</p>
      <div className="grid gap-3">
        <LaunchCard title="/todo" desc="Daily list + Corner Conditions + Crash Report" onClick={onOpenTodo} />
        <LaunchCard title="/uplink" desc="Request Patch Note from the Nice Glitch" onClick={() => alert("/uplink coming next.")} />
      </div>
      <div className="mt-4 text-[11px] text-zinc-500">Hint: /todo saves locally and resets per‑day. Carry over undone tasks if you want.</div>
    </div>
  );
}

function LaunchCard({ title, desc, onClick }) {
  return (
    <button onClick={onClick} className="group text-left rounded-xl border border-zinc-800 bg-zinc-900/60 p-4 hover:border-emerald-500/60 hover:bg-zinc-900 transition">
      <div className="flex items-center justify-between">
        <div>
          <div className="font-mono text-emerald-300 text-sm">{title}</div>
          <div className="text-zinc-400 text-[12px]">{desc}</div>
        </div>
        <svg className="opacity-60 group-hover:opacity-100 transition" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
      </div>
    </button>
  );
}

// ---- TODO WINDOW (persistent per-day + 22‑day challenge) ----
function TodoWindow({ onClose }) {
  const today = ymd();
  const yesterday = prevYmd();
  const [tasks, setTasks] = useLocalState(`ng.todo.${today}`, []);
  const [newTask, setNewTask] = useState("");
  const [filter, setFilter] = useState("all"); // all | open | done
  const [challengeStart, setChallengeStart] = useState(getOrInitChallengeStart());

  // Derived
  const stats = useMemo(() => {
    const total = tasks.length;
    const done = tasks.filter((t) => t.done).length;
    const open = total - done;
    const pct = total ? Math.round((done / total) * 100) : 0;
    return { total, done, open, pct };
  }, [tasks]);

  const challengeDay = useMemo(() => computeChallengeDay(challengeStart, today, CHALLENGE_TOTAL), [challengeStart, today]);

  // Actions
  function addTask() {
    const t = newTask.trim();
    if (!t) return;
    const id = `t-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`;
    setTasks([...tasks, { id, text: t, done: false }]);
    setNewTask("");
  }
  function toggleTask(id) {
    setTasks(toggleById(tasks, id));
  }
  function removeTask(id) {
    setTasks(tasks.filter((x) => x.id !== id));
  }
  function clearDone() {
    setTasks(tasks.filter((x) => !x.done));
  }
  function addCornerDefaults() {
    const incoming = CORNER_DEFAULTS.filter((d) => !tasks.some((t) => t.id === d.id)).map((d) => ({ id: d.id, text: d.text, done: false, preset: true }));
    setTasks([...tasks, ...incoming]);
  }
  function carryOverFromYesterday() {
    try {
      const raw = localStorage.getItem(`ng.todo.${yesterday}`);
      if (!raw) return;
      const yTasks = JSON.parse(raw) || [];
      const merged = mergeCarryOver(tasks, yTasks);
      setTasks(merged);
    } catch {}
  }
  async function exportMarkdown() {
    const md = generateMarkdown(today, tasks, stats, challengeDay);
    let copied = false;
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(md);
        copied = true;
      }
    } catch {}
    if (!copied) {
      // Fallback: download a .md file
      const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `nice-glitch-${today}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    alert(copied ? "Copied today’s tasks to clipboard as Markdown." : "Downloaded today’s tasks as .md file.");
  }

  function resetChallenge() {
    const fresh = ymd();
    setChallengeStart(fresh);
    try { localStorage.setItem("ng.challenge.start", fresh); } catch {}
  }

  const filtered = tasks.filter((t) => (filter === "all" ? true : filter === "done" ? t.done : !t.done));

  return (
    <div className="rounded-2xl border border-zinc-800 bg-zinc-950/70 p-5 backdrop-blur">
      {/* Top bar */}
      <div className="flex items-center justify-between gap-2 mb-4">
        <div>
          <div className="text-sm text-zinc-300">/todo — <span className="text-zinc-400">{today}</span></div>
          <div className="text-[11px] text-zinc-500">Tasks auto‑save locally. Tip: add Corner Conditions first.</div>
        </div>
        <div className="flex items-center gap-2 text-xs">
          <button onClick={addCornerDefaults} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Add Corner Defaults</button>
          <button onClick={carryOverFromYesterday} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Carry Over ⟲</button>
          <button onClick={clearDone} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Clear Done</button>
          <button onClick={exportMarkdown} className="rounded-md border border-zinc-700 px-2 py-1 hover:bg-zinc-900">Export .md</button>
          <button onClick={onClose} className="rounded-md border border-emerald-700/60 text-emerald-300 px-2 py-1 hover:bg-emerald-950/40">Exit</button>
        </div>
      </div>

      {/* Progress + Challenge Day */}
      <div className="mb-4">
        <div className="flex items-center justify-between text-[11px] text-zinc-500 mb-1">
          <span>Progress <span className="text-zinc-400">(Day {challengeDay}/{CHALLENGE_TOTAL})</span></span>
          <span>{stats.pct}% ({stats.done}/{stats.total})</span>
        </div>
        <div className="w-full h-2 rounded-full bg-zinc-900 overflow-hidden"><div className="h-full bg-emerald-500" style={{ width: `${stats.pct}%` }} /></div>
        <div className="mt-1 text-[11px] text-zinc-500 flex items-center justify-between">
          <span>Challenge start: <span className="text-zinc-400">{challengeStart}</span></span>
          <button onClick={resetChallenge} className="underline hover:text-zinc-300">reset day 1</button>
        </div>
      </div>

      {/* Add Task */}
      <div className="flex gap-2 mb-3">
        <input value={newTask} onChange={(e) => setNewTask(e.target.value)} onKeyDown={(e) => { if (e.key === "Enter") addTask(); }} placeholder="Add a task…" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" />
        <button onClick={addTask} className="rounded-xl px-4 py-2 bg-emerald-500 text-zinc-900 text-sm font-semibold hover:bg-emerald-400 transition">Add</button>
      </div>

      {/* Filters */}
      <div className="flex items-center gap-2 text-xs mb-2">
        {[
          { id: "all", label: "All" },
          { id: "open", label: "Open" },
          { id: "done", label: "Done" },
        ].map((f) => (
          <button key={f.id} onClick={() => setFilter(f.id)} className={`px-2 py-1 rounded-md border ${filter === f.id ? 'border-emerald-500/60 bg-emerald-500/10 text-emerald-300' : 'border-zinc-700 hover:bg-zinc-900 text-zinc-300'}`}>{f.label}</button>
        ))}
      </div>

      {/* Task list */}
      <div className="space-y-2">
        {filtered.length === 0 && (
          <div className="text-sm text-zinc-500 border border-dashed border-zinc-700 rounded-xl p-4">No tasks here. Add one above, or <button className="underline ml-1" onClick={addCornerDefaults}>insert Corner Defaults</button>.</div>
        )}
        {filtered.map((t) => (
          <div key={t.id} className="flex items-center justify-between gap-2 rounded-xl border border-zinc-800 bg-zinc-900/60 px-3 py-2">
            <label className="flex items-center gap-3 cursor-pointer select-none">
              <input type="checkbox" className="size-4 accent-emerald-500" checked={!!t.done} onChange={() => toggleTask(t.id)} />
              <span className={`text-sm ${t.preset ? "text-zinc-100" : "text-zinc-300"} ${t.done ? "line-through text-zinc-500" : ""}`}>{t.text}</span>
            </label>
            {!t.preset && (
              <button onClick={() => removeTask(t.id)} className="text-[11px] text-zinc-500 hover:text-zinc-300">remove</button>
            )}
          </div>
        ))}
      </div>

      {/* Diagnostics / self-tests */}
      <Diagnostics />
    </div>
  );
}

function Diagnostics() {
  const results = useMemo(() => {
    // Test 1: Markdown uses \n joins and contains tasks
    const sampleTasks = [
      { id: "1", text: "Task A", done: false },
      { id: "2", text: "Task B", done: true },
    ];
    const sampleStats = { pct: 50, done: 1, total: 2 };
    const md = generateMarkdown("2099-01-01", sampleTasks, sampleStats, 5);
    const t1 = md.includes("(Day 5/22)") && md.includes("\n- [ ] Task A\n- [x] Task B") && !md.includes("\r\n");

    // Test 2: merge carry-over dedupes by text and ignores done
    const yTasks = [
      { id: "y1", text: "A", done: true },
      { id: "y2", text: "B", done: false },
      { id: "y3", text: "C", done: false },
    ];
    const today = [{ id: "t1", text: "B", done: false }];
    const merged = mergeCarryOver(today, yTasks);
    const t2 = merged.some((m) => m.text === "B") && merged.some((m) => m.text === "C") && !merged.some((m) => m.text === "A");

    // Test 3: toggleById flips done
    const toggled = toggleById([{ id: "z", text: "Z", done: false }], "z");
    const t3 = toggled[0].done === true;

    // Test 4: challenge day math
    const start = "2025-01-01";
    const d1 = computeChallengeDay(start, "2025-01-01"); // same day
    const d2 = computeChallengeDay(start, "2025-01-02"); // +1 day
    const d22 = computeChallengeDay(start, "2025-01-22"); // 22nd day
    const dCap = computeChallengeDay(start, "2025-02-15"); // capped at 22
    const t4 = d1 === 1 && d2 === 2 && d22 === 22 && dCap === 22;

    // Test 5: Markdown header formatting includes date and day label
    const md2 = generateMarkdown("2099-12-31", [], { pct: 0, done: 0, total: 0 }, 1);
    const t5 = md2.startsWith("# Nice Glitch — 2099-12-31 (Day 1/22)\nProgress: 0% (0/0)\n\n");

    // Test 6: daysBetween works over month boundaries
    const t6 = daysBetween("2025-01-31", "2025-02-02") === 2;

    return [
      { name: "Markdown includes Day X/22 and uses \\n", pass: t1 },
      { name: "Carry-over merges undone, dedupes by text", pass: t2 },
      { name: "toggleById flips done", pass: t3 },
      { name: "Challenge day computation correct & capped", pass: t4 },
      { name: "Markdown header has date + day label", pass: t5 },
      { name: "daysBetween handles month change", pass: t6 },
    ];
  }, []);

  const allPass = results.every((r) => r.pass);

  return (
    <div className="mt-6 rounded-xl border border-zinc-800 bg-zinc-900/60 p-3">
      <div className="flex items-center justify-between mb-2">
        <div className="text-sm text-zinc-300">Diagnostics</div>
        <div className={`text-xs ${allPass ? "text-emerald-400" : "text-red-400"}`}>{allPass ? "All tests passed" : "Some tests failed"}</div>
      </div>
      <ul className="text-[12px] space-y-1">
        {results.map((r, i) => (
          <li key={i} className={r.pass ? "text-emerald-300" : "text-red-300"}>{r.pass ? "✓" : "✗"} {r.name}</li>
        ))}
      </ul>
    </div>
  );
}

function Backdrop() {
  return (
    <>
      <div className="absolute -top-40 -left-32 w-[44rem] h-[44rem] rounded-full bg-purple-700/25 blur-3xl" />
      <div className="absolute -bottom-40 right-0 w-[36rem] h-[36rem] rounded-full bg-emerald-500/20 blur-3xl" />
      <div className="absolute inset-0 [mask-image:radial-gradient(70%_60%_at_50%_20%,black,transparent)]"><Stars /></div>
    </>
  );
}

function Stars() {
  const dots = Array.from({ length: 140 }, (_, i) => i);
  return (
    <svg className="absolute inset-0 w-full h-full">
      {dots.map((i) => (
        <circle key={i} cx={Math.random() * 100 + "%"} cy={Math.random() * 100 + "%"} r={(Math.random() * 0.8 + 0.2).toFixed(2)} fill="white" opacity={Math.random() * 0.6 + 0.1} />
      ))}
    </svg>
  );
}

function Glitch({ children }) {
  return (
    <span className="relative inline-block">
      <span className="relative z-10">{children}</span>
      <span className="absolute inset-0 -translate-x-[1px] -translate-y-[1px] text-emerald-400/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
      <span className="absolute inset-0 translate-x-[1px] translate-y-[1px] text-fuchsia-500/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
    </span>
  );
}
