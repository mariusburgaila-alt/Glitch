<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLITCH v6 — Dashboard Nav</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#0B0B0C] text-zinc-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* ---------- UTILS (same as v5) ---------- */
    function ymd(date = new Date()) { const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,"0"); const d=String(date.getDate()).padStart(2,"0"); return `${y}-${m}-${d}`; }
    function prevYmd(){ const d=new Date(); d.setDate(d.getDate()-1); return ymd(d); }
    function useLocalState(key, initial){
      const [state,setState]=useState(()=>{ try{const v=localStorage.getItem(key); return v?JSON.parse(v):initial;}catch{ return initial; }});
      useEffect(()=>{ try{localStorage.setItem(key,JSON.stringify(state));}catch{} },[key,state]);
      return [state,setState];
    }
    function formatPrettyDate(dateStr){
      if(!dateStr) return "";
      const date=new Date(`${dateStr}T00:00:00`);
      if(Number.isNaN(date.getTime())) return dateStr;
      const formatter=new Intl.DateTimeFormat(undefined,{ weekday:"long", month:"long", day:"numeric" });
      return formatter.format(date);
    }
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

    /* ---------- CHALLENGE HELPERS (same) ---------- */
    const CHALLENGE_TOTAL=22;
    function parseYmd(s){ const [y,m,d]=(s||"").split("-").map(Number); if(!y||!m||!d) return null; return new Date(Date.UTC(y,m-1,d)); }
    function daysBetween(a,b){ const A=parseYmd(a), B=parseYmd(b); if(!A||!B) return 0; return Math.floor((B-A)/(1000*60*60*24)); }
    function computeChallengeDay(startStr,todayStr,total=CHALLENGE_TOTAL){ const d=Math.max(0,daysBetween(startStr,todayStr)); return Math.max(1,Math.min(total,d+1)); }
    function getOrInitChallengeStart(){ try{const v=localStorage.getItem("ng.challenge.start"); if(v) return v;}catch{} const t=ymd(); try{localStorage.setItem("ng.challenge.start",t);}catch{} return t; }

    /* ---------- DATA HELPERS (same) ---------- */
    const CORNER_DEFAULTS=[
      {id:"cc-move",text:"Move 10 minutes (walk/Zone 2)",preset:true},
      {id:"cc-breathe",text:"5 mindful breaths + one word",preset:true},
      {id:"cc-build",text:"25-min build block (highest leverage)",preset:true},
      {id:"cc-service",text:"1 micro-service (helpful ping)",preset:true},
    ];
    function generateMarkdown(dateStr,tasks,stats,dayX=null){
      const lines=[
        `# Nice Glitch — ${dateStr}${dayX?` (Day ${dayX}/${CHALLENGE_TOTAL})`:""}`,
        `Progress: ${stats.pct}% (${stats.done}/${stats.total})`,
        "",
        ...tasks.map(t => `${t.done?"- [x]":"- [ ]"} ${t.text}`)
      ];
      return lines.join("\n");
    }
    function mergeCarryOver(todayTasks, yTasks) {
      const undone=(yTasks||[]).filter(t=>!t.done);
      const merged=[...todayTasks];
      undone.forEach(t=>{
        if(!merged.some(m=>m.text===t.text)){
          merged.push({id:`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,text:t.text,done:false,createdAt:Date.now()});
        }
      });
      return merged;
    }
    function toggleById(list,id){ return list.map(x=>x.id===id?{...x,done:!x.done,completedAt:!x.done?Date.now():undefined}:x); }

    /* ---------- DECOR ---------- */
    function Backdrop(){
      return (<>
        <div className="absolute -top-40 -left-32 w-[44rem] h-[44rem] rounded-full bg-purple-700/25 blur-3xl" />
        <div className="absolute -bottom-40 right-0 w-[36rem] h-[36rem] rounded-full bg-emerald-500/20 blur-3xl" />
        <div className="absolute inset-0 [mask-image:radial-gradient(70%_60%_at_50%_20%,black,transparent)]"><Stars/></div>
      </>);
    }
    function Stars(){
      const dots=Array.from({length:140},(_,i)=>i);
      return (<svg className="absolute inset-0 w-full h-full">
        {dots.map(i=>(<circle key={i} cx={Math.random()*100+"%"} cy={Math.random()*100+"%"} r={(Math.random()*0.8+0.2).toFixed(2)} fill="white" opacity={Math.random()*0.6+0.1}/>))}
      </svg>);
    }
    function Glitch({children}){
      return (
        <span className="relative inline-block">
          <span className="relative z-10">{children}</span>
          <span className="absolute inset-0 -translate-x-[1px] -translate-y-[1px] text-emerald-400/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
          <span className="absolute inset-0 translate-x-[1px] translate-y-[1px] text-fuchsia-500/70 blur-[0.5px] select-none" aria-hidden>{children}</span>
        </span>
      );
    }

    /* ---------- EVENT for header “Add task” ---------- */
    function focusAddTask(){ window.dispatchEvent(new Event('ng:add-focus')); }

    /* ---------- CHAT (unchanged logic; compacted for brevity) ---------- */
    const GLITCH_PERSONA = `You are GLITCH — tough-love astronaut coach. Brief, green terminal. Action first.`;
    function ChatWindow(){
      const [input,setInput]=useState("");
      const [model,setModel]=useState("gpt-4o-mini");
      const [enabled,setEnabled]=useLocalState("ng.agent.enabled", true);
      const [msgs,setMsgs]=useLocalState("ng.chat.log", [{who:"ai", text:"GLITCH uplink online. How can I help, operator?"}]);
      const logRef=useRef(null);
      const API_BASE = location.hostname.endsWith('vercel.app') ? '' : 'https://glitch-rouge.vercel.app';
      useEffect(()=>{ if(logRef.current){ logRef.current.scrollTop=logRef.current.scrollHeight; } },[msgs]);
      useEffect(()=>{ const h=(e)=>setMsgs(m=>[...m,{who:"ai",text:e.detail.text}]); window.addEventListener("ng:agent",h); return ()=>window.removeEventListener("ng:agent",h); },[]);
      async function send(){
        const t=input.trim(); if(!t) return;
        setMsgs(m=>[...m,{who:"me",text:t}]); setInput("");
        try{
          const context = msgs.slice(-12).map(m => ({ role: m.who==='ai'?'assistant':'user', content: m.text }));
          const r = await fetch(`${API_BASE}/api/chat`, { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ model, system: GLITCH_PERSONA, messages: [...context, { role:'user', content: t }] }) });
          const data=await r.json();
          if(!r.ok){ setMsgs(m=>[...m,{who:"ai",text:`Error: ${data?.error||'OpenAI error'}`}]); return; }
          setMsgs(m=>[...m,{who:"ai",text:(data?.content||'').trim()||'(no content)'}]);
        }catch{ setMsgs(m=>[...m,{who:"ai",text:'Network error.'}]); }
      }
      return (
        <section id="chat" className="rounded-2xl border border-zinc-800 bg-zinc-950/70 p-5 backdrop-blur flex flex-col h-full">
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm text-zinc-300">/chat — <span className="text-zinc-500">AI link</span></div>
            <div className="flex items-center gap-2">
              <label className="text-[11px] text-zinc-500 flex items-center gap-1">
                <input type="checkbox" className="accent-emerald-500" checked={enabled} onChange={e=>setEnabled(e.target.checked)} /> Proactive
              </label>
              <select value={model} onChange={e=>setModel(e.target.value)} className="bg-zinc-900 border border-zinc-700 px-2 py-1 rounded-md text-xs">
                <option value="gpt-4o-mini">Fast (4o-mini)</option>
                <option value="gpt-5">Deep (GPT-5)</option>
              </select>
            </div>
          </div>
          <div ref={logRef} className="flex-1 overflow-auto rounded-xl border border-zinc-800 bg-black/40 p-3 space-y-2">
            {msgs.map((m,i)=>(
              <div key={i} className={`max-w-[85%] rounded-lg px-3 py-2 text-sm ${m.who==='me'
                ? 'ml-auto bg-zinc-900 text-zinc-200 border border-zinc-700'
                : 'mr-auto bg-zinc-900/40 border border-emerald-700/40 text-emerald-300'}`}>{m.text}</div>
            ))}
          </div>
          <div className="mt-3 flex gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') send(); }}
                   placeholder="Type a message…" className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500" />
            <button onClick={send} className="rounded-xl px-4 py-2 bg-emerald-500 text-zinc-900 text-sm font-semibold hover:bg-emerald-400 transition">Send</button>
          </div>
          <div className="mt-2 text-[11px] text-zinc-500">Replies in <span className="text-emerald-300">green</span>. Uses your <code>/api/chat</code>.</div>
        </section>
      );
    }

    /* ---------- PROACTIVE AGENT + TIMER (same as v5) ---------- */
    function emitAgent(text){ window.dispatchEvent(new CustomEvent("ng:agent", { detail:{ text } })); }
    function useProactiveAgent(tasks, enabled){
      useEffect(()=>{
        if(!enabled) return;
        const tick=()=>{ const now=Date.now(); const DEFAULT_MIN=30;
          const RULES=[{match:/move|walk|zone\s*2/i,min:10,msg:t=>`Quick win: ${t}. 10-minute Zone-2 — start now; report back ✅`},
                       {match:/build|block|focus|write/i,min:25,msg:t=>`Deep block: ${t}. Set 25-minute timer. Phone down. Go.`},
                       {match:/breath|breathe|mindful|meditat/i,min:10,msg:t=>`Reset nervous system: ${t}. 5 mindful breaths — in 4, hold 4, out 6.`},
                       {match:/service|ping|email|reply/i,min:20,msg:t=>`Micro-service: ${t}. Send the helpful ping. One take. Ship.`}];
          (tasks||[]).forEach(task=>{
            if(task.done) return;
            const created=task.createdAt||Date.now(); const ageMin=(now-created)/60000;
            let min=DEFAULT_MIN, templ=(txt)=>`Still open: ${txt}. Pick a tiny first move; 5 minutes only.`;
            for(const r of RULES){ if(r.match.test(task.text)){ min=r.min; templ=r.msg; break; } }
            if(ageMin>=min){
              const lastKey=`ng.agent.last.${task.id}`; const last=Number(localStorage.getItem(lastKey)||0);
              if(now-last>15*60*1000){ localStorage.setItem(lastKey,String(now)); emitAgent(templ(task.text)); }
            }
          });
        };
        const id=setInterval(tick,60*1000), start=setTimeout(tick,5000);
        return ()=>{ clearInterval(id); clearTimeout(start); };
      }, [JSON.stringify(tasks), enabled]);
    }
    function useFocusTimer(){
      const [state,setState]=useState({taskId:null,duration:0,startedAt:0,halfAnnounced:false,running:false,remaining:0});
      useEffect(()=>{
        if(!state.running) return;
        const id=setInterval(()=>{
          const elapsed=Math.floor((Date.now()-state.startedAt)/1000);
          const rem=clamp(state.duration - elapsed, 0, state.duration);
          setState(s=>({...s,remaining:rem}));
          if(!state.halfAnnounced && elapsed>=Math.floor(state.duration/2)){
            setState(s=>({...s,halfAnnounced:true})); emitAgent("Halfway. Two breaths. Stay on the same tab. Keep going.");
          }
          if(rem<=0){ setState(s=>({...s,running:false})); emitAgent("Time. Mark it done or extend 5 minutes?"); }
        },1000);
        return ()=>clearInterval(id);
      },[state.running,state.startedAt,state.duration,state.halfAnnounced]);
      function start(taskId,minutes){ const dur=minutes*60; setState({taskId,duration:dur,startedAt:Date.now(),halfAnnounced:false,running:true,remaining:dur}); emitAgent(`Timer armed: ${minutes} minutes — focus mode.`); }
      function stop(){ setState(s=>({...s,running:false})); }
      return { state, start, stop, setState };
    }

    /* ---------- TODO (with small listener for header Add) ---------- */
    function TodoWindow({ onClose, onTasksChange }){
      const today=ymd(), yesterday=prevYmd();
      const [tasks,setTasks]=useLocalState(`ng.todo.${today}` ,[]);
      const [newTask,setNewTask]=useState("");
      const [filter,setFilter]=useState("all");
      const [challengeStart,setChallengeStart]=useState(getOrInitChallengeStart());
      const [focusNote,setFocusNote]=useLocalState(`ng.focus.${today}`,"");
      const [calendarUrl,setCalendarUrl]=useLocalState("ng.calendar.url","");
      const [calendarDraft,setCalendarDraft]=useState(calendarUrl);
      const [showOne,setShowOne]=useLocalState("ng.showOne", false);
      const [selectedId,setSelectedId]=useState(null);
      const [focusId,setFocusId]=useState(null);
      const addInputRef=useRef(null);
      const timer=useFocusTimer();

      useEffect(()=>{ if((tasks||[]).some(t=>!t.createdAt)){ setTasks(ts=>ts.map(t=>t.createdAt? t : {...t,createdAt:Date.now()})); } },[]);
      useEffect(()=>{ onTasksChange?.(tasks); },[tasks]);

      // focus Add from header
      useEffect(()=>{ const h=()=>addInputRef.current?.focus(); window.addEventListener('ng:add-focus',h); return ()=>window.removeEventListener('ng:add-focus',h); },[]);

      const stats=useMemo(()=>{ const total=tasks.length, done=tasks.filter(t=>t.done).length, open=total-done, pct=total?Math.round(done/total*100):0; return {total,done,open,pct}; },[tasks]);
      const challengeDay=useMemo(()=>computeChallengeDay(challengeStart,today,CHALLENGE_TOTAL),[challengeStart,today]);
      const prettyToday=useMemo(()=>formatPrettyDate(today),[today]);

      useEffect(()=>{ setCalendarDraft(calendarUrl||""); },[calendarUrl]);

      const filtered=tasks.filter(t=>filter==="all"?true:filter==="done"?t.done:!t.done);
      const firstOpen=tasks.find(t=>!t.done);
      const displayTasks=useMemo(()=>{
        if(timer.state.running && focusId) return filtered.filter(t=>t.id===focusId);
        if(showOne){ if(focusId) return filtered.filter(t=>t.id===focusId); return firstOpen? filtered.filter(t=>t.id===firstOpen.id):[]; }
        return filtered;
      }, [filtered, showOne, focusId, timer.state.running, firstOpen?.id]);

      useEffect(()=>{ if(!selectedId && displayTasks.length>0){ setSelectedId(displayTasks[0].id); } },[displayTasks, selectedId]);

      function addTask(){ const t=newTask.trim(); if(!t) return; const id=`t-${Date.now()}-${Math.random().toString(36).slice(2,7)}`; setTasks([...tasks,{id,text:t,done:false,createdAt:Date.now()}]); setNewTask(""); setSelectedId(id); }
      function toggleTask(id){ setTasks(toggleById(tasks,id)); }
      function removeTask(id){ setTasks(tasks.filter(x=>x.id!==id)); if(id===selectedId) setSelectedId(null); if(id===focusId) setFocusId(null); }
      function clearDone(){ setTasks(tasks.filter(x=>!x.done)); }
      function addCornerDefaults(){ const incoming=CORNER_DEFAULTS.filter(d=>!tasks.some(t=>t.id===d.id)).map(d=>({id:d.id,text:d.text,done:false,preset:true,createdAt:Date.now()})); setTasks([...tasks,...incoming]); }
      function carryOverFromYesterday(){ try{ const raw=localStorage.getItem(`ng.todo.${yesterday}`); if(!raw) return; const yTasks=JSON.parse(raw)||[]; setTasks(mergeCarryOver(tasks,yTasks)); }catch{} }
      async function exportMarkdown(){ const md=generateMarkdown(today,tasks,stats,challengeDay); let copied=false; try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(md); copied=true; } }catch{} if(!copied){ const blob=new Blob([md],{type:"text/markdown;charset=utf-8"}); const url=URL.createObjectURL(blob), a=document.createElement("a"); a.href=url; a.download=`nice-glitch-${today}.md`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);} alert(copied?"Copied today’s tasks to clipboard as Markdown.":"Downloaded today’s tasks as .md file."); }
      function resetChallenge(){ const fresh=ymd(); setChallengeStart(fresh); try{localStorage.setItem("ng.challenge.start",fresh);}catch{} }
      function saveCalendarLink(){ setCalendarUrl((calendarDraft||"").trim()); }
      function clearCalendarLink(){ setCalendarUrl(""); setCalendarDraft(""); }

      // keyboard shortcuts (same as v5)
      useEffect(()=>{
        let tArmedAt=0;
        const onKey=(e)=>{
          const tag=(e.target.tagName||'').toLowerCase();
          const typing=tag==='input'||tag==='textarea'||e.isComposing;
          if(e.key.toLowerCase()==='n'){ e.preventDefault(); addInputRef.current?.focus(); return; }
          if(typing) return;
          if(e.key==='Enter'){ e.preventDefault(); addTask(); return; }
          if(e.key.toLowerCase()==='j'){ e.preventDefault(); if(displayTasks.length===0) return; const idx=Math.max(0,displayTasks.findIndex(t=>t.id===selectedId)); const next=displayTasks[Math.min(idx+1,displayTasks.length-1)]; setSelectedId(next?.id||selectedId); return; }
          if(e.key.toLowerCase()==='k'){ e.preventDefault(); if(displayTasks.length===0) return; const idx=Math.max(0,displayTasks.findIndex(t=>t.id===selectedId)); const prev=displayTasks[Math.max(idx-1,0)]; setSelectedId(prev?.id||selectedId); return; }
          if(e.key===' '){ e.preventDefault(); if(selectedId) toggleTask(selectedId); return; }
          if(e.key.toLowerCase()==='t'){ tArmedAt=Date.now(); return; }
          if((e.key==='5'||e.key==='2') && selectedId && Date.now()-tArmedAt<1200){ e.preventDefault(); setFocusId(selectedId); timer.start(selectedId, e.key==='5'?5:25); return; }
        };
        window.addEventListener('keydown',onKey);
        return ()=>window.removeEventListener('keydown',onKey);
      }, [displayTasks, selectedId]);

      const focusTask=tasks.find(t=>t.id===focusId)||null;
      const fmt=(s)=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
      const inFocus=!!focusTask;

      return (
        <section id="todo" className="rounded-2xl border border-zinc-800 bg-zinc-950/70 p-5 backdrop-blur space-y-5">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div className="text-xs uppercase tracking-wide text-zinc-500">Module</div>
              <div className="text-lg font-semibold text-zinc-100">/todo</div>
              <div className="text-[11px] text-zinc-500">Tasks auto-save locally. Focus wins.</div>
            </div>
            <div className="flex flex-wrap items-center gap-2 text-xs">
              <button onClick={addCornerDefaults} className="rounded-md border border-zinc-700 px-3 py-1.5 hover:bg-zinc-900 transition">Add Corner Defaults</button>
              <button onClick={carryOverFromYesterday} className="rounded-md border border-zinc-700 px-3 py-1.5 hover:bg-zinc-900 transition">Carry Over ⟲</button>
              <button onClick={clearDone} className="rounded-md border border-zinc-700 px-3 py-1.5 hover:bg-zinc-900 transition">Clear Done</button>
              <button onClick={()=>setShowOne(!showOne)} className={`rounded-md px-3 py-1.5 border transition ${showOne?'border-emerald-500/60 bg-emerald-500/10 text-emerald-300':'border-zinc-700 hover:bg-zinc-900 text-zinc-300'}`}>{showOne?'Show All':'Show One'}</button>
              <button onClick={exportMarkdown} className="rounded-md border border-zinc-700 px-3 py-1.5 hover:bg-zinc-900 transition">Export .md</button>
              <button onClick={onClose} className="rounded-md border border-emerald-700/60 text-emerald-300 px-3 py-1.5 hover:bg-emerald-950/40 transition">Exit</button>
            </div>
          </div>

          <div className="rounded-2xl border border-emerald-900/40 bg-gradient-to-br from-emerald-950/60 via-zinc-950/60 to-zinc-950/20 p-4">
            <div className="flex flex-wrap items-end justify-between gap-4">
              <div>
                <div className="text-[11px] uppercase tracking-[0.2em] text-zinc-500">Today</div>
                <div className="text-xl font-semibold text-zinc-100">{prettyToday}</div>
                <div className="text-sm text-zinc-400">{today}</div>
              </div>
              <div className="text-right">
                <div className="text-[11px] uppercase tracking-[0.2em] text-zinc-500">Challenge</div>
                <div className="text-lg font-semibold text-emerald-400">Day {challengeDay} / {CHALLENGE_TOTAL}</div>
                <button onClick={resetChallenge} className="text-[11px] text-emerald-200/70 underline-offset-2 hover:text-emerald-200 underline">reset day 1</button>
              </div>
            </div>
          </div>

          <div className="grid gap-5 lg:grid-cols-[1.75fr_1fr]">
            <div className="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 space-y-4">
              <div className="flex flex-wrap items-end justify-between gap-3">
                <div>
                  <div className="text-sm font-semibold text-zinc-100">Task Queue</div>
                  <div className="text-[12px] text-zinc-500">Sort by completion or focus on open items below.</div>
                </div>
                <div className="text-right text-[11px] text-zinc-500">
                  <div>Progress</div>
                  <div className="text-sm text-emerald-300 font-semibold">{stats.pct}% • {stats.done}/{stats.total}</div>
                </div>
              </div>

              <div className="flex gap-2">
                <input
                  ref={addInputRef}
                  value={newTask}
                  onChange={e=>setNewTask(e.target.value)}
                  onKeyDown={e=>{ if(e.key==="Enter") addTask(); }}
                  placeholder="Add a task…"
                  className="flex-1 rounded-xl bg-black/40 border border-zinc-800 px-3 py-2 text-sm outline-none focus:border-zinc-500"
                />
                <button onClick={addTask} className="rounded-xl px-4 py-2 bg-emerald-500 text-zinc-900 text-sm font-semibold hover:bg-emerald-400 transition">Add</button>
              </div>

              <div className="flex flex-wrap items-center gap-2 text-xs">
                {[
                  {id:"all",label:"All"},
                  {id:"open",label:"Open"},
                  {id:"done",label:"Done"},
                ].map(f=>(
                  <button
                    key={f.id}
                    onClick={()=>setFilter(f.id)}
                    className={`px-3 py-1.5 rounded-md border transition ${filter===f.id?'border-emerald-500/60 bg-emerald-500/10 text-emerald-300':'border-zinc-700 hover:bg-zinc-800/80 text-zinc-300'}`}
                  >
                    {f.label}
                  </button>
                ))}
              </div>

              {inFocus && (
                <div className="rounded-xl border border-emerald-700/50 bg-emerald-900/10 p-4 space-y-3">
                  <div className="flex flex-wrap items-center justify-between gap-3">
                    <div className="text-sm text-emerald-300 font-semibold">Focus: {focusTask?.text}</div>
                    <div className="flex items-center gap-3 text-[11px] text-zinc-400">
                      {timer.state.running ? (
                        <>
                          <span>Remaining: <span className="text-emerald-300 font-mono">{fmt(timer.state.remaining)}</span></span>
                          <button onClick={()=>timer.stop()} className="px-2 py-1 rounded-md border border-zinc-700 hover:bg-zinc-900">Pause</button>
                        </>
                      ) : (
                        <>
                          <button onClick={()=>timer.start(focusTask.id,5)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Start 5m</button>
                          <button onClick={()=>timer.start(focusTask.id,25)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Start 25m</button>
                        </>
                      )}
                      <button onClick={()=>{ if(timer.state.running) timer.stop(); setFocusId(null); setShowOne(false); }} className="px-2 py-1 rounded-md border border-zinc-700 hover:bg-zinc-900" title="Exit focus view">Exit</button>
                    </div>
                  </div>
                  <div className="w-full h-2 rounded-full bg-emerald-950/50 overflow-hidden">
                    <div className="h-full bg-emerald-500 transition-all" style={{width:`${100*(1-(timer.state.remaining||0)/(timer.state.duration||1))}%`}}/>
                  </div>
                  {!timer.state.running && (
                    <div className="flex flex-wrap items-center gap-2 text-[12px] text-zinc-400">
                      <button onClick={()=>{ toggleTask(focusTask.id); }} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">Mark done</button>
                      <button onClick={()=>timer.start(focusTask.id,5)} className="px-2 py-1 rounded-md border border-emerald-600 text-emerald-300 hover:bg-emerald-950/30">+5 min</button>
                    </div>
                  )}
                </div>
              )}

              <div className="space-y-2 max-h-[360px] overflow-y-auto pr-1">
                {displayTasks.length===0 && (
                  <div className="text-sm text-zinc-500 border border-dashed border-zinc-700 rounded-xl p-4">
                    {showOne
                      ? <>Nothing to display. <button className="underline" onClick={()=>setShowOne(false)}>Show all tasks</button>.</>
                      : <>No tasks here. Add one above, or <button className="underline" onClick={addCornerDefaults}>insert Corner Defaults</button>.</>}
                  </div>
                )}
                {displayTasks.map(t=>(
                  <div
                    key={t.id}
                    onClick={()=>{ setSelectedId(t.id); }}
                    className={`flex items-center justify-between gap-2 rounded-xl border border-zinc-800 bg-black/30 px-3 py-2 cursor-pointer ${t.id===selectedId?'border-emerald-600 bg-black/40':'hover:border-emerald-600/40'}`}
                  >
                    <label className="flex items-center gap-3 cursor-pointer select-none">
                      <input type="checkbox" className="size-4 accent-emerald-500" checked={!!t.done} onChange={(e)=>{ e.stopPropagation(); toggleTask(t.id); }} />
                      <span className={`text-sm ${t.preset?"text-zinc-100":"text-zinc-300"} ${t.done?"line-through text-zinc-500":""}`}>{t.text}</span>
                    </label>
                    <div className="flex items-center gap-3">
                      <button onClick={(e)=>{ e.stopPropagation(); setFocusId(t.id); setSelectedId(t.id); setShowOne(true); }} className="text-[11px] text-emerald-300 hover:underline">focus</button>
                      {!t.preset && (
                        <button onClick={(e)=>{ e.stopPropagation(); removeTask(t.id); }} className="text-[11px] text-zinc-500 hover:text-zinc-300">remove</button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="space-y-4">
              <div className="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 space-y-4">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-sm font-semibold text-zinc-100">Daily Metrics</div>
                    <div className="text-[12px] text-zinc-500">Challenge start: <span className="text-zinc-300">{challengeStart}</span></div>
                  </div>
                  <button onClick={resetChallenge} className="text-[11px] text-emerald-300 underline-offset-2 hover:text-emerald-200 underline">reset day 1</button>
                </div>
                <div>
                  <div className="mb-1 flex items-center justify-between text-[11px] text-zinc-500">
                    <span>Overall Progress</span>
                    <span>{stats.pct}%</span>
                  </div>
                  <div className="h-2 w-full overflow-hidden rounded-full bg-zinc-950">
                    <div className="h-full bg-emerald-500 transition-all" style={{width:`${stats.pct}%`}} />
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-center text-sm">
                  <div className="rounded-xl border border-zinc-800 bg-black/30 px-3 py-2">
                    <div className="text-[11px] uppercase tracking-wide text-zinc-500">Total</div>
                    <div className="text-lg font-semibold text-zinc-100">{stats.total}</div>
                  </div>
                  <div className="rounded-xl border border-zinc-800 bg-black/30 px-3 py-2">
                    <div className="text-[11px] uppercase tracking-wide text-zinc-500">Open</div>
                    <div className="text-lg font-semibold text-amber-300">{stats.open}</div>
                  </div>
                  <div className="rounded-xl border border-zinc-800 bg-black/30 px-3 py-2">
                    <div className="text-[11px] uppercase tracking-wide text-zinc-500">Done</div>
                    <div className="text-lg font-semibold text-emerald-300">{stats.done}</div>
                  </div>
                </div>
              </div>

              <div className="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
                <div className="flex items-start justify-between gap-3 mb-3">
                  <div>
                    <div className="text-sm font-semibold text-zinc-100">Daily Focus</div>
                    <div className="text-[12px] text-zinc-500">Name the highlight or theme you want to protect today.</div>
                  </div>
                  <button onClick={()=>setFocusNote("")} className="text-[11px] text-zinc-500 hover:text-zinc-300 underline">clear</button>
                </div>
                <textarea
                  value={focusNote}
                  onChange={e=>setFocusNote(e.target.value)}
                  rows={4}
                  placeholder="e.g. Ship landing page hero, 90m focus block at 2pm."
                  className="w-full rounded-xl border border-zinc-800 bg-black/30 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-zinc-600 focus:outline-none"
                />
              </div>

              <div className="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
                <div className="flex items-start justify-between gap-3 mb-3">
                  <div>
                    <div className="text-sm font-semibold text-zinc-100">Calendar Link</div>
                    <div className="text-[12px] text-zinc-500">Embed your Google Calendar for quick reference.</div>
                  </div>
                  {(calendarUrl || calendarDraft) && (
                    <button onClick={clearCalendarLink} className="text-[11px] text-zinc-500 hover:text-zinc-300 underline">reset</button>
                  )}
                </div>
                {calendarUrl ? (
                  <div className="overflow-hidden rounded-xl border border-zinc-800 bg-black/30">
                    <iframe
                      key={calendarUrl}
                      src={calendarUrl}
                      title="Google Calendar"
                      className="h-64 w-full border-0"
                      loading="lazy"
                      referrerPolicy="no-referrer"
                    />
                  </div>
                ) : (
                  <div className="rounded-xl border border-dashed border-zinc-700 bg-black/20 p-4 text-sm text-zinc-500">
                    Paste the <span className="text-zinc-300">public embed URL</span> from Google Calendar to pin it here.
                  </div>
                )}
                <div className="mt-3 space-y-2">
                  <input
                    value={calendarDraft}
                    onChange={e=>setCalendarDraft(e.target.value)}
                    placeholder="https://calendar.google.com/calendar/embed?..."
                    className="w-full rounded-xl border border-zinc-800 bg-black/30 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-zinc-600 focus:outline-none"
                  />
                  <button onClick={saveCalendarLink} className="w-full rounded-xl bg-emerald-500 py-2 text-sm font-semibold text-zinc-900 hover:bg-emerald-400 transition">Save calendar link</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      );
    }

    /* ---------- DIAGNOSTICS (same) ---------- */
    function Diagnostics(){
      const results=useMemo(()=>{
        const sampleTasks=[{id:"1",text:"Task A",done:false},{id:"2",text:"Task B",done:true}];
        const sampleStats={pct:50,done:1,total:2};
        const md=generateMarkdown("2099-01-01",sampleTasks,sampleStats,5);
        const t1=md.includes("(Day 5/22)")&&md.includes("\n- [ ] Task A\n- [x] Task B")&&!md.includes("\r\n");
        const yTasks=[{id:"y1",text:"A",done:true},{id:"y2",text:"B",done:false},{id:"y3",text:"C",done:false}];
        const today=[{id:"t1",text:"B",done:false}];
        const merged=mergeCarryOver(today,yTasks);
        const t2=merged.some(m=>m.text==="B")&&merged.some(m=>m.text==="C")&&!merged.some(m=>m.text==="A");
        const t3=toggleById([{id:"z",text:"Z",done:false}],"z")[0].done===true;
        const start="2025-01-01";
        const d1=computeChallengeDay(start,"2025-01-01"), d2=computeChallengeDay(start,"2025-01-02"),
              d22=computeChallengeDay(start,"2025-01-22"), dCap=computeChallengeDay(start,"2025-02-15");
        const t4=d1===1&&d2===2&&d22===22&&dCap===22;
        const md2=generateMarkdown("2099-12-31",[],{pct:0,done:0,total:0},1);
        const t5=md2.startsWith("# Nice Glitch — 2099-12-31 (Day 1/22)\nProgress: 0% (0/0)\n\n");
        const t6=daysBetween("2025-01-31","2025-02-02")===2;
        return [
          {name:"Markdown includes Day X/22 and uses \\n",pass:t1},
          {name:"Carry-over merges undone, dedupes by text",pass:t2},
          {name:"toggleById flips done",pass:t3},
          {name:"Challenge day computation correct & capped",pass:t4},
          {name:"Markdown header has date + day label",pass:t5},
          {name:"daysBetween handles month change",pass:t6},
        ];
      },[]);
      const allPass=results.every(r=>r.pass);
      return (
        <div className="mt-6 rounded-xl border border-zinc-800 bg-zinc-900/60 p-3">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm text-zinc-300">Diagnostics</div>
            <div className={`text-xs ${allPass?"text-emerald-400":"text-red-400"}`}>{allPass?"All tests passed":"Some tests failed"}</div>
          </div>
          <ul className="text-[12px] space-y-1">
            {results.map((r,i)=>(
              <li key={i} className={r.pass?"text-emerald-300":"text-red-300"}>{r.pass?"✓":"✗"} {r.name}</li>
            ))}
          </ul>
        </div>
      );
    }

    /* ---------- TOP NAV (new) ---------- */
    function TopNav(){
      const items = [
        { id:'overview', label:'Overview', target:'top' },
        { id:'tasks', label:'Tasks', target:'todo' },
        { id:'chat', label:'Chat', target:'chat' },
        { id:'uplink', label:'Uplink', target:null, disabled:true },
        { id:'archive', label:'Archive', target:null, disabled:true },
        { id:'settings', label:'Settings', target:null, disabled:true },
      ];
      function go(target){
        if(target==='top'){ window.scrollTo({ top:0, behavior:'smooth' }); return; }
        const el=document.getElementById(target); if(el) el.scrollIntoView({ behavior:'smooth', block:'start' });
      }
      return (
        <header className="sticky top-0 z-50">
          <div className="border-b border-white/10 bg-zinc-950/70 backdrop-blur supports-[backdrop-filter]:bg-zinc-950/50">
            <div className="mx-auto max-w-6xl px-4 h-14 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="inline-grid place-items-center size-9 rounded-xl bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-purple-600 via-fuchsia-500 to-emerald-400 shadow-lg shadow-purple-900/30 border border-white/10">
                  <span className="font-black text-white tracking-wide">NG</span>
                </div>
                <div className="font-semibold tracking-tight"><Glitch>Nice Glitch</Glitch></div>
              </div>
              <nav className="hidden md:flex items-center gap-2 text-sm">
                {items.map(it=>(
                  <button key={it.id}
                          onClick={()=> it.target ? go(it.target) : null}
                          title={it.disabled ? 'Coming soon' : it.label}
                          className={`px-3 py-1.5 rounded-lg border ${it.disabled
                            ? 'cursor-not-allowed opacity-40 border-zinc-800 text-zinc-500'
                            : 'border-zinc-800 hover:border-emerald-600 hover:bg-emerald-500/5'}`}>
                    {it.label}
                  </button>
                ))}
                <button onClick={focusAddTask} className="ml-2 px-3 py-1.5 rounded-lg bg-emerald-500 text-zinc-900 font-medium hover:bg-emerald-400">Add task</button>
              </nav>
            </div>
          </div>
        </header>
      );
    }

    /* ---------- APP ---------- */
    function App(){
      const [agentEnabled] = useLocalState("ng.agent.enabled", true);
      const [liveTasks,setLiveTasks] = useState([]);
      useProactiveAgent(liveTasks, agentEnabled);

      return (
        <div className="relative min-h-screen overflow-hidden" id="top">
          <Backdrop/>
          <TopNav/>

          <main className="relative z-10 mx-auto max-w-6xl px-4 pt-6 pb-16">
            {/* small page intro */}
            <div className="mb-6">
              <p className="text-zinc-400 text-sm">Exact Corner Event • Fracture Window ▸ Secret Access</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <TodoWindow onClose={()=>{}} onTasksChange={setLiveTasks}/>
              <div className="min-h-[28rem]"><ChatWindow/></div>
            </div>

            <Diagnostics/>
            <footer className="mt-8 text-center text-[11px] text-zinc-500">
              © {new Date().getFullYear()} Nice Glitch — <span className="text-zinc-300">Make the corner. Get the note.</span>
            </footer>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
